<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ContUber</title>

  <!-- ‚úÖ Favicon (coloque o arquivo na raiz do repo, no mesmo n√≠vel do index.html) -->
  <link rel="icon" href="favicon_contuber_full.ico" />

  <style>
    :root{
      --bg:#0b0c10;
      --card:#12131a;
      --card2:#0f1016;
      --border:rgba(255,255,255,.10);
      --text:#e9e9ee;
      --muted:#a6a7b2;
      --accent:#ff8a00;
      --good:#20c997;
      --bad:#ff4d4f;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --radius: 18px;
      font-synthesis-weight:none;
      text-rendering: optimizeLegibility;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(255,138,0,.18), transparent 55%),
        radial-gradient(900px 500px at 70% 20%, rgba(100,50,200,.16), transparent 60%),
        radial-gradient(1100px 700px at 40% 80%, rgba(0,200,255,.08), transparent 60%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    header{
      padding:24px 24px 0;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
    }
    .brand h1{margin:0;font-size:28px;letter-spacing:.3px}
    .brand p{margin:4px 0 0;color:var(--muted);font-size:13px}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
      user-select:none;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}
    main{
      padding:18px 24px 32px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:18px;
    }
    @media (max-width: 980px){
      main{grid-template-columns:1fr}
    }
    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 16px 0;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .card .hd h2{
      margin:0;
      font-size:18px;
    }
    .card .hd small{color:var(--muted)}
    .card .bd{padding:16px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media (max-width: 620px){
      .grid2,.grid3{grid-template-columns:1fr}
    }
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    input::placeholder{color:rgba(255,255,255,.35)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
    }
    .btn:hover{filter:brightness(1.1)}
    .btn.acc{
      background: linear-gradient(180deg, rgba(255,138,0,.95), rgba(255,138,0,.75));
      border-color: rgba(255,138,0,.35);
      color:#111;
    }
    .btn.danger{
      background: rgba(255,77,79,.18);
      border-color: rgba(255,77,79,.35);
      color: #ffd6d6;
    }
    .msg{
      margin-top:12px;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,77,79,.35);
      background: rgba(255,77,79,.10);
      color:#ffd6d6;
      font-size:13px;
      display:none;
      white-space:pre-wrap;
    }
    .msg.ok{
      border-color: rgba(32,201,151,.35);
      background: rgba(32,201,151,.10);
      color:#c8fff0;
    }
    .sep{height:1px;background:var(--border);margin:14px 0}
    .chips{
      display:flex;flex-wrap:wrap;gap:10px;
      margin-top:10px;
    }
    .chip{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.20);
      font-size:13px;color:var(--text);
    }
    .chip strong{font-weight:800}
    .chip.good .dot{background:var(--good)}
    .chip.bad .dot{background:var(--bad)}
    .mini{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .kpi{
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      border-radius:14px;
      padding:12px;
    }
    .kpi .t{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:16px;margin-top:6px;font-weight:900}
    .kpi .s{font-size:12px;color:var(--muted);margin-top:3px}
    .hide{display:none !important}
    .rightTop{
      display:flex;gap:10px;align-items:center;
    }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <h1>ContUber</h1>
      <p>Controle por fechamento (carro) + seguro ‚Ä¢ login + Firestore ‚Ä¢ bruto/l√≠quido (hoje e total)</p>
    </div>
    <div class="rightTop">
      <div class="pill" id="connPill"><span class="dot bad"></span><span id="connTxt">Offline</span></div>
      <button class="btn danger hide" id="btnSair">Sair</button>
    </div>
  </header>

  <main>
    <!-- ESQUERDA: Login / Setup / Lan√ßamento -->
    <section class="card" id="cardEsq">
      <div class="hd">
        <div>
          <h2 id="tituloEsq">Login</h2>
          <small id="subEsq">Entre ou crie sua conta. No primeiro login, configure os dados base.</small>
        </div>
      </div>
      <div class="bd">

        <!-- LOGIN -->
        <div id="loginBox">
          <div class="grid2">
            <div>
              <label for="email">Email</label>
              <input id="email" type="email" placeholder="seu@email.com" />
            </div>
            <div>
              <label for="senha">Senha (m√≠n. 6)</label>
              <input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" />
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button class="btn acc" id="btnEntrar">Entrar</button>
            <button class="btn" id="btnCadastrar">Cadastrar</button>
            <button class="btn" id="btnLimpar">Limpar</button>
          </div>

          <div class="msg" id="msgLogin"></div>

          <div class="sep"></div>
          <small style="color:var(--muted);font-size:12px">
            Se aparecer <b>auth/api-key-not-valid</b>:
            voc√™ precisa usar o <b>firebaseConfig do seu App Web no Firebase Console</b> (Config do SDK),
            e N√ÉO a ‚ÄúBrowser key‚Äù isolada do Google Cloud. E se voc√™ restringiu a chave por dom√≠nio,
            inclua seu dom√≠nio do GitHub Pages em <b>Restri√ß√µes do aplicativo ‚Üí Sites</b>.
          </small>
        </div>

        <!-- SETUP INICIAL -->
        <div id="setupBox" class="hide">
          <div class="grid2">
            <div>
              <label>Dia de fechamento do carro (1‚Äì28)</label>
              <input id="carroDia" type="number" min="1" max="28" placeholder="ex: 21" />
            </div>
            <div>
              <label>Meta di√°ria (R$)</label>
              <input id="metaDia" type="number" step="0.01" placeholder="ex: 200" />
            </div>
          </div>

          <div class="sep"></div>

          <div class="grid2">
            <div>
              <label>Dia do pagamento do seguro (1‚Äì28)</label>
              <input id="seguroDia" type="number" min="1" max="28" placeholder="ex: 15" />
            </div>
            <div>
              <label>Valor do seguro (R$)</label>
              <input id="seguroValor" type="number" step="0.01" placeholder="ex: 364" />
            </div>
          </div>

          <div class="sep"></div>

          <div class="grid2">
            <div>
              <label>Quantidade total de parcelas</label>
              <input id="parcelasTotal" type="number" min="1" placeholder="ex: 48" />
            </div>
            <div>
              <label>Valor da parcela (R$)</label>
              <input id="parcelaValor" type="number" step="0.01" placeholder="ex: 1250" />
            </div>
          </div>

          <div class="grid2" style="margin-top:12px">
            <div>
              <label>Saldo financiado inicial (R$)</label>
              <input id="saldoInicial" type="number" step="0.01" placeholder="ex: 137280" />
            </div>
            <div>
              <label>Consumo alvo (opcional) km/L</label>
              <input id="consumoAlvo" type="number" step="0.01" placeholder="ex: 10.5" />
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button class="btn acc" id="btnSalvarSetup">Salvar configura√ß√£o</button>
          </div>

          <div class="msg" id="msgSetup"></div>
        </div>

        <!-- APP (LAN√áAMENTO DO DIA + RELAT√ìRIO) -->
        <div id="appBox" class="hide">
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div style="color:var(--muted);font-size:13px">
              Logado como: <span id="userEmail" style="color:var(--text);font-weight:800"></span>
              <div style="margin-top:4px">Per√≠odo atual: <b id="periodoAtual">‚Äî</b></div>
            </div>
            <div class="row">
              <button class="btn" id="btnRecarregar">Recarregar</button>
              <button class="btn danger" id="btnResetHoje">Limpar hoje</button>
            </div>
          </div>

          <div class="sep"></div>

          <div class="grid2">
            <div>
              <label>Ganho bruto do dia (R$)</label>
              <input id="ganhoBruto" type="number" step="0.01" placeholder="ex: 320" />
            </div>
            <div>
              <label>Horas trabalhadas (h)</label>
              <input id="horas" type="number" step="0.1" placeholder="ex: 8" />
            </div>
          </div>

          <div class="grid2" style="margin-top:12px">
            <div>
              <label>KM rodado (dia)</label>
              <input id="kmRodado" type="number" step="0.1" placeholder="ex: 145.5" />
            </div>
            <div>
              <label>Litros abastecidos (dia)</label>
              <input id="litros" type="number" step="0.01" placeholder="ex: 20" />
            </div>
          </div>

          <div class="grid2" style="margin-top:12px">
            <div>
              <label>Valor gasto com combust√≠vel (R$)</label>
              <input id="valorCombustivel" type="number" step="0.01" placeholder="ex: 120" />
            </div>
            <div>
              <label>Alimenta√ß√£o (R$)</label>
              <input id="alimentacao" type="number" step="0.01" placeholder="ex: 25" />
            </div>
          </div>

          <div class="grid2" style="margin-top:12px">
            <div>
              <label>Reserva manuten√ß√£o (R$)</label>
              <input id="manutencao" type="number" step="0.01" placeholder="ex: 20" />
            </div>
            <div>
              <label>Outros gastos (R$)</label>
              <input id="outros" type="number" step="0.01" placeholder="ex: 10" />
            </div>
          </div>

          <div class="sep"></div>

          <div class="grid2">
            <div class="kpi">
              <div class="t">Hoje pagou a parcela?</div>
              <div class="row" style="margin-top:8px">
                <label style="display:flex;align-items:center;gap:8px;color:var(--text);margin:0">
                  <input id="parcelaPaga" type="checkbox" style="width:auto" />
                  Sim, descontar parcela hoje
                </label>
              </div>
              <div class="s" style="margin-top:6px;color:var(--muted)">
                (Se marcar, desconta a parcela do l√≠quido e reduz parcelas/saldo.)
              </div>
            </div>
            <div class="kpi">
              <div class="t">Hoje pagou o seguro?</div>
              <div class="row" style="margin-top:8px">
                <label style="display:flex;align-items:center;gap:8px;color:var(--text);margin:0">
                  <input id="seguroPago" type="checkbox" style="width:auto" />
                  Sim, descontar seguro hoje
                </label>
              </div>
              <div class="s" style="margin-top:6px;color:var(--muted)">
                (Se marcar, desconta o seguro do l√≠quido hoje.)
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:14px">
            <button class="btn acc" id="btnSalvarDia">Salvar dia</button>
          </div>

          <div class="msg" id="msgApp"></div>
        </div>

      </div>
    </section>

    <!-- DIREITA: Status r√°pido -->
    <aside class="card">
      <div class="hd">
        <div>
          <h2>Status r√°pido</h2>
          <small id="statusLogin">N√£o logado</small>
        </div>
      </div>

      <div class="bd">
        <div class="chips" id="chipsTop">
          <div class="chip"><span class="dot good"></span> Fechamento carro: dia <strong id="chipCarroDia">‚Äî</strong></div>
          <div class="chip"><span class="dot good"></span> Seguro: dia <strong id="chipSeguroDia">‚Äî</strong> (<strong id="chipSeguroValor">‚Äî</strong>)</div>
          <div class="chip bad"><span class="dot"></span> Saldo financiamento: <strong id="chipSaldo">‚Äî</strong></div>
          <div class="chip"><span class="dot good"></span> Meta di√°ria: <strong id="chipMeta">‚Äî</strong></div>
        </div>

        <div class="sep"></div>

        <div class="mini">
          <div class="kpi">
            <div class="t">Bruto hoje</div>
            <div class="v" id="brutoHoje">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="t">L√≠quido hoje</div>
            <div class="v" id="liquidoHoje">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="t">Bruto total (per√≠odo)</div>
            <div class="v" id="brutoTotal">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="t">L√≠quido total (per√≠odo)</div>
            <div class="v" id="liquidoTotal">‚Äî</div>
          </div>
        </div>

        <div class="mini" style="margin-top:10px">
          <div class="kpi">
            <div class="t">Gastos hoje</div>
            <div class="v" id="gastosHoje">‚Äî</div>
            <div class="s" id="gastosHojeDet">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="t">Gastos total (per√≠odo)</div>
            <div class="v" id="gastosTotal">‚Äî</div>
            <div class="s" id="gastosTotalDet">‚Äî</div>
          </div>
        </div>

        <div class="mini" style="margin-top:10px">
          <div class="kpi">
            <div class="t">Consumo hoje</div>
            <div class="v" id="kmlHoje">‚Äî</div>
            <div class="s" id="combKmHoje">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="t">Combust√≠vel hoje</div>
            <div class="v" id="combR$Hoje">‚Äî</div>
            <div class="s" id="combLHoje">‚Äî</div>
          </div>
        </div>

        <div class="mini" style="margin-top:10px">
          <div class="kpi">
            <div class="t">R$/km (hoje)</div>
            <div class="v" id="rsPorKmHoje">‚Äî</div>
            <div class="s" id="kmHoje">‚Äî</div>
          </div>
          <div class="kpi">
            <div class="t">R$/hora (hoje)</div>
            <div class="v" id="rsPorHoraHoje">‚Äî</div>
            <div class="s" id="metaStatusHoje">‚Äî</div>
          </div>
        </div>

        <div class="sep"></div>
        <small id="alertasTxt" style="color:var(--muted);font-size:12px">
          Alertas: ‚Äî
        </small>
      </div>
    </aside>
  </main>

  <!-- Firebase (Modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, setDoc, updateDoc,
      collection, getDocs, query, where
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ‚úÖ SEU firebaseConfig (do App Web no Firebase Console ‚Üí Config do SDK)
    const firebaseConfig = {
      apiKey: "AIzaSyAZCCtQvKNn94cdJdsL-ceZNR87gwoQhKg",
      authDomain: "contuber-1c9ca.firebaseapp.com",
      projectId: "contuber-1c9ca",
      storageBucket: "contuber-1c9ca.firebasestorage.app",
      messagingSenderId: "333645182595",
      appId: "1:333645182595:web:147d3ad84116b595324db6"
    };

    // ===== init =====
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== DOM helpers =====
    const $ = (id) => document.getElementById(id);
    const n = (v) => Number(v || 0);
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const hojeISO = () => new Date().toISOString().slice(0,10);

    function moeda(v){
      return (n(v)).toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
    }
    function num(v, casas=2){
      return (n(v)).toLocaleString("pt-BR", { minimumFractionDigits: casas, maximumFractionDigits: casas });
    }
    function setMsg(el, text, ok=false){
      el.textContent = text;
      el.classList.toggle("ok", !!ok);
      el.style.display = "block";
    }
    function clearMsg(el){
      el.textContent = "";
      el.style.display = "none";
      el.classList.remove("ok");
    }

    // ===== per√≠odo por fechamento =====
    function getPeriodoAtual(carroDia){
      const d = new Date();
      const dia = d.getDate();
      const fechamento = clamp(n(carroDia), 1, 28);

      // in√≠cio do ciclo: se hoje >= fechamento => in√≠cio = fechamento do m√™s atual
      // sen√£o => in√≠cio = fechamento do m√™s anterior
      const start = new Date(d);
      if(dia >= fechamento){
        start.setDate(fechamento);
      } else {
        start.setMonth(start.getMonth()-1);
        start.setDate(fechamento);
      }

      const end = new Date(start);
      end.setMonth(end.getMonth()+1);
      end.setDate(end.getDate()-1);

      const fmt = (x)=> x.toLocaleDateString("pt-BR");
      return { start, end, label: `${fmt(start)} ‚Üí ${fmt(end)}` };
    }

    // ===== c√°lculos =====
    function calcularDia(dia, perfil){
      const bruto = n(dia.bruto);
      const horas = n(dia.horas);
      const km = n(dia.km);
      const litros = n(dia.litros);
      const combustivel = n(dia.combustivel);
      const alimentacao = n(dia.alimentacao);
      const manutencao = n(dia.manutencao);
      const outros = n(dia.outros);

      const parcelaValor = n(perfil?.parcelaValor);
      const seguroValor  = n(perfil?.seguroValor);

      const parcela = dia.parcelaPaga ? parcelaValor : 0;
      const seguro  = dia.seguroPago ? seguroValor : 0;

      const gastos = combustivel + alimentacao + manutencao + outros + parcela + seguro;
      const liquido = bruto - gastos;

      const kml = (litros > 0) ? (km / litros) : 0;
      const custoPorKm = (km > 0) ? (combustivel / km) : 0;
      const porHora = (horas > 0) ? (bruto / horas) : 0;

      return { bruto, liquido, gastos, km, litros, combustivel, kml, custoPorKm, horas, porHora,
               det: {alimentacao, manutencao, outros, parcela, seguro} };
    }

    function somarDias(dias, perfil){
      const tot = { bruto:0, liquido:0, gastos:0, km:0, litros:0, combustivel:0, horas:0,
                    det:{alimentacao:0, manutencao:0, outros:0, parcela:0, seguro:0} };
      for(const d of dias){
        const c = calcularDia(d, perfil);
        tot.bruto += c.bruto;
        tot.liquido += c.liquido;
        tot.gastos += c.gastos;
        tot.km += c.km;
        tot.litros += c.litros;
        tot.combustivel += c.combustivel;
        tot.horas += c.horas;
        tot.det.alimentacao += c.det.alimentacao;
        tot.det.manutencao += c.det.manutencao;
        tot.det.outros += c.det.outros;
        tot.det.parcela += c.det.parcela;
        tot.det.seguro += c.det.seguro;
      }
      tot.kml = tot.litros > 0 ? (tot.km / tot.litros) : 0;
      tot.custoPorKm = tot.km > 0 ? (tot.combustivel / tot.km) : 0;
      tot.porHora = tot.horas > 0 ? (tot.bruto / tot.horas) : 0;
      return tot;
    }

    function renderResumo({perfil, hojeCalc, totalCalc, hojeDia, periodoLabel}){
      // chips topo
      $("chipCarroDia").textContent = perfil?.carroDia ?? "‚Äî";
      $("chipSeguroDia").textContent = perfil?.seguroDia ?? "‚Äî";
      $("chipSeguroValor").textContent = perfil?.seguroValor ? moeda(perfil.seguroValor) : "‚Äî";
      $("chipSaldo").textContent = perfil?.saldoFinanciamento ? moeda(perfil.saldoFinanciamento) : "‚Äî";
      $("chipMeta").textContent = perfil?.metaDia ? moeda(perfil.metaDia) : "‚Äî";

      $("periodoAtual").textContent = periodoLabel || "‚Äî";

      // KPIs bruto/liquido
      $("brutoHoje").textContent = moeda(hojeCalc.bruto);
      $("liquidoHoje").textContent = moeda(hojeCalc.liquido);
      $("brutoTotal").textContent = moeda(totalCalc.bruto);
      $("liquidoTotal").textContent = moeda(totalCalc.liquido);

      // gastos
      $("gastosHoje").textContent = moeda(hojeCalc.gastos);
      $("gastosTotal").textContent = moeda(totalCalc.gastos);

      $("gastosHojeDet").textContent =
        `Comb ${moeda(hojeCalc.combustivel)} ‚Ä¢ Alim ${moeda(hojeCalc.det.alimentacao)} ‚Ä¢ Manut ${moeda(hojeCalc.det.manutencao)} ‚Ä¢ Outros ${moeda(hojeCalc.det.outros)}`
        + (hojeDia?.parcelaPaga ? ` ‚Ä¢ Parc ${moeda(hojeCalc.det.parcela)}` : "")
        + (hojeDia?.seguroPago ? ` ‚Ä¢ Seguro ${moeda(hojeCalc.det.seguro)}` : "");

      $("gastosTotalDet").textContent =
        `Comb ${moeda(totalCalc.combustivel)} ‚Ä¢ Alim ${moeda(totalCalc.det.alimentacao)} ‚Ä¢ Manut ${moeda(totalCalc.det.manutencao)} ‚Ä¢ Outros ${moeda(totalCalc.det.outros)}`
        + (totalCalc.det.parcela ? ` ‚Ä¢ Parc ${moeda(totalCalc.det.parcela)}` : "")
        + (totalCalc.det.seguro ? ` ‚Ä¢ Seguro ${moeda(totalCalc.det.seguro)}` : "");

      // consumo e combust√≠vel
      $("kmlHoje").textContent = hojeCalc.kml ? `${num(hojeCalc.kml,2)} km/L` : "‚Äî";
      $("combKmHoje").textContent = hojeCalc.custoPorKm ? `${moeda(hojeCalc.custoPorKm)} / km` : "‚Äî";
      $("combR$Hoje").textContent = hojeCalc.combustivel ? moeda(hojeCalc.combustivel) : "‚Äî";
      $("combLHoje").textContent = hojeCalc.litros ? `${num(hojeCalc.litros,2)} L` : "‚Äî";

      $("rsPorKmHoje").textContent = hojeCalc.custoPorKm ? moeda(hojeCalc.custoPorKm) : "‚Äî";
      $("kmHoje").textContent = hojeCalc.km ? `${num(hojeCalc.km,1)} km` : "‚Äî";

      $("rsPorHoraHoje").textContent = hojeCalc.porHora ? moeda(hojeCalc.porHora) : "‚Äî";

      // meta status (usando L√çQUIDO vs meta)
      const meta = n(perfil?.metaDia);
      if(meta > 0){
        const ok = hojeCalc.liquido >= meta;
        $("metaStatusHoje").textContent = ok ? `‚úÖ Meta batida (l√≠q.)` : `‚è≥ Falta ${moeda(meta - hojeCalc.liquido)}`;
      } else {
        $("metaStatusHoje").textContent = "Defina meta di√°ria no setup";
      }

      // alertas pagamento
      const hoje = new Date();
      const diaHoje = hoje.getDate();
      const alerts = [];
      if(n(perfil?.carroDia) === diaHoje) alerts.push("üöó Hoje √© dia do fechamento/pagamento do carro.");
      if(n(perfil?.seguroDia) === diaHoje) alerts.push("üõ°Ô∏è Hoje √© dia do pagamento do seguro.");
      if(alerts.length === 0) alerts.push("‚Äî");
      $("alertasTxt").textContent = "Alertas: " + alerts.join(" ");
    }

    // ===== estado =====
    let currentUser = null;
    let perfil = null;
    let hojeDiaDoc = null;
    let diasPeriodo = [];

    // ===== firestore paths =====
    function perfilRef(uid){ return doc(db, "users", uid, "dados", "perfil"); }
    function diaRef(uid, iso){ return doc(db, "users", uid, "dias", iso); }
    function diasCol(uid){ return collection(db, "users", uid, "dias"); }

    // ===== carregar dados =====
    async function carregarTudo(){
      if(!currentUser) return;

      // perfil
      const pSnap = await getDoc(perfilRef(currentUser.uid));
      perfil = pSnap.exists() ? pSnap.data() : null;

      if(!perfil){
        // precisa setup
        $("setupBox").classList.remove("hide");
        $("appBox").classList.add("hide");
        $("tituloEsq").textContent = "Configura√ß√£o inicial";
        $("subEsq").textContent = "Defina fechamento, seguro, parcelas e saldo financiado.";
        return;
      }

      // per√≠odo atual
      const periodo = getPeriodoAtual(perfil.carroDia);
      $("periodoAtual").textContent = periodo.label;

      // dias do per√≠odo: como Firestore n√£o consulta por data de docId f√°cil,
      // aqui buscamos tudo e filtramos em JS (para MVP simples).
      // Se crescer, a gente muda para salvar um campo "date" e consultar por range.
      const allSnap = await getDocs(diasCol(currentUser.uid));
      const all = [];
      allSnap.forEach(d => all.push(d.data()));

      // filtrar por ISO date dentro do per√≠odo
      const startISO = periodo.start.toISOString().slice(0,10);
      const endISO = periodo.end.toISOString().slice(0,10);
      diasPeriodo = all
        .filter(x => x && x.iso && x.iso >= startISO && x.iso <= endISO)
        .sort((a,b)=> (a.iso > b.iso ? 1 : -1));

      // hoje
      const iso = hojeISO();
      const hSnap = await getDoc(diaRef(currentUser.uid, iso));
      hojeDiaDoc = hSnap.exists() ? hSnap.data() : {
        iso,
        bruto:0, horas:0, km:0, litros:0, combustivel:0,
        alimentacao:0, manutencao:0, outros:0,
        parcelaPaga:false, seguroPago:false
      };

      // preencher inputs com o que j√° existe hoje
      $("ganhoBruto").value = hojeDiaDoc.bruto ?? 0;
      $("horas").value = hojeDiaDoc.horas ?? 0;
      $("kmRodado").value = hojeDiaDoc.km ?? 0;
      $("litros").value = hojeDiaDoc.litros ?? 0;
      $("valorCombustivel").value = hojeDiaDoc.combustivel ?? 0;
      $("alimentacao").value = hojeDiaDoc.alimentacao ?? 0;
      $("manutencao").value = hojeDiaDoc.manutencao ?? 0;
      $("outros").value = hojeDiaDoc.outros ?? 0;
      $("parcelaPaga").checked = !!hojeDiaDoc.parcelaPaga;
      $("seguroPago").checked = !!hojeDiaDoc.seguroPago;

      // render
      const hojeCalc = calcularDia(hojeDiaDoc, perfil);
      const totalCalc = somarDias(diasPeriodo, perfil);
      renderResumo({perfil, hojeCalc, totalCalc, hojeDia:hojeDiaDoc, periodoLabel: periodo.label});
    }

    // ===== a√ß√µes: auth =====
    $("btnLimpar").addEventListener("click", ()=>{
      $("email").value = "";
      $("senha").value = "";
      clearMsg($("msgLogin"));
    });

    $("btnEntrar").addEventListener("click", async ()=>{
      clearMsg($("msgLogin"));
      try{
        const email = $("email").value.trim();
        const senha = $("senha").value;
        await signInWithEmailAndPassword(auth, email, senha);
        setMsg($("msgLogin"), "Login realizado com sucesso!", true);
      }catch(e){
        setMsg($("msgLogin"), "Erro: " + (e?.code || e?.message || e));
      }
    });

    $("btnCadastrar").addEventListener("click", async ()=>{
      clearMsg($("msgLogin"));
      try{
        const email = $("email").value.trim();
        const senha = $("senha").value;
        await createUserWithEmailAndPassword(auth, email, senha);
        setMsg($("msgLogin"), "Conta criada! Voc√™ j√° est√° logado.", true);
      }catch(e){
        setMsg($("msgLogin"), "Erro: " + (e?.code || e?.message || e));
      }
    });

    $("btnSair").addEventListener("click", async ()=>{
      await signOut(auth);
    });

    // ===== setup =====
    $("btnSalvarSetup").addEventListener("click", async ()=>{
      clearMsg($("msgSetup"));
      try{
        const carroDia = clamp(n($("carroDia").value), 1, 28);
        const metaDia = n($("metaDia").value);
        const seguroDia = clamp(n($("seguroDia").value), 1, 28);
        const seguroValor = n($("seguroValor").value);
        const parcelasTotal = clamp(n($("parcelasTotal").value), 1, 999);
        const parcelaValor = n($("parcelaValor").value);
        const saldoInicial = n($("saldoInicial").value);
        const consumoAlvo = n($("consumoAlvo").value);

        const perfilNovo = {
          carroDia,
          metaDia,
          seguroDia,
          seguroValor,
          parcelasTotal,
          parcelasRestantes: parcelasTotal,
          parcelaValor,
          saldoFinanciamento: saldoInicial,
          consumoAlvo,
          updatedAt: Date.now()
        };

        await setDoc(perfilRef(currentUser.uid), perfilNovo, { merge:true });
        setMsg($("msgSetup"), "Configura√ß√£o salva!", true);

        $("setupBox").classList.add("hide");
        $("appBox").classList.remove("hide");
        await carregarTudo();
      }catch(e){
        setMsg($("msgSetup"), "Erro: " + (e?.code || e?.message || e));
      }
    });

    // ===== app actions =====
    $("btnRecarregar").addEventListener("click", async ()=>{
      clearMsg($("msgApp"));
      try{
        await carregarTudo();
        setMsg($("msgApp"), "Recarregado.", true);
      }catch(e){
        setMsg($("msgApp"), "Erro: " + (e?.code || e?.message || e));
      }
    });

    $("btnResetHoje").addEventListener("click", async ()=>{
      clearMsg($("msgApp"));
      try{
        // zera inputs (n√£o apaga do banco, s√≥ prepara)
        $("ganhoBruto").value = 0;
        $("horas").value = 0;
        $("kmRodado").value = 0;
        $("litros").value = 0;
        $("valorCombustivel").value = 0;
        $("alimentacao").value = 0;
        $("manutencao").value = 0;
        $("outros").value = 0;
        $("parcelaPaga").checked = false;
        $("seguroPago").checked = false;
        setMsg($("msgApp"), "Campos de hoje limpos (n√£o apagou do banco).", true);
      }catch(e){
        setMsg($("msgApp"), "Erro: " + (e?.code || e?.message || e));
      }
    });

    $("btnSalvarDia").addEventListener("click", async ()=>{
      clearMsg($("msgApp"));
      try{
        if(!perfil) throw new Error("Perfil n√£o carregado.");

        const iso = hojeISO();
        const dia = {
          iso,
          bruto: n($("ganhoBruto").value),
          horas: n($("horas").value),
          km: n($("kmRodado").value),
          litros: n($("litros").value),
          combustivel: n($("valorCombustivel").value),
          alimentacao: n($("alimentacao").value),
          manutencao: n($("manutencao").value),
          outros: n($("outros").value),
          parcelaPaga: $("parcelaPaga").checked,
          seguroPago: $("seguroPago").checked,
          updatedAt: Date.now()
        };

        // Antes de salvar, precisamos saber se "parcelaPaga" mudou de false->true hoje
        const prevSnap = await getDoc(diaRef(currentUser.uid, iso));
        const prev = prevSnap.exists() ? prevSnap.data() : null;
        const parcelaAntes = !!(prev && prev.parcelaPaga);
        const parcelaAgora = !!dia.parcelaPaga;

        // salva dia
        await setDoc(diaRef(currentUser.uid, iso), dia, { merge:true });

        // se marcou parcela agora e antes n√£o tinha: desconta no saldo e reduz parcelas restantes
        if(parcelaAgora && !parcelaAntes){
          const rest = n(perfil.parcelasRestantes);
          const val = n(perfil.parcelaValor);
          const saldo = n(perfil.saldoFinanciamento);

          const novoRest = Math.max(0, rest - 1);
          const novoSaldo = Math.max(0, saldo - val);

          await updateDoc(perfilRef(currentUser.uid), {
            parcelasRestantes: novoRest,
            saldoFinanciamento: novoSaldo,
            updatedAt: Date.now()
          });

          // atualiza em mem√≥ria para render
          perfil.parcelasRestantes = novoRest;
          perfil.saldoFinanciamento = novoSaldo;
        }

        setMsg($("msgApp"), "Dia salvo com sucesso!", true);
        await carregarTudo();
      }catch(e){
        setMsg($("msgApp"), "Erro: " + (e?.code || e?.message || e));
      }
    });

    // ===== auth state =====
    onAuthStateChanged(auth, async (user)=>{
      currentUser = user;

      if(!user){
        $("btnSair").classList.add("hide");
        $("statusLogin").textContent = "N√£o logado";
        $("loginBox").classList.remove("hide");
        $("setupBox").classList.add("hide");
        $("appBox").classList.add("hide");
        $("tituloEsq").textContent = "Login";
        $("subEsq").textContent = "Entre ou crie sua conta. No primeiro login, configure os dados base.";
        return;
      }

      $("btnSair").classList.remove("hide");
      $("userEmail").textContent = user.email || user.uid;
      $("statusLogin").textContent = "Logado";

      $("loginBox").classList.add("hide");
      $("tituloEsq").textContent = "Painel";
      $("subEsq").textContent = "Lance seu dia e acompanhe bruto/l√≠quido, consumo e totais do per√≠odo.";

      await carregarTudo();
      if(perfil){
        $("setupBox").classList.add("hide");
        $("appBox").classList.remove("hide");
      }
    });

    // ===== conex√£o (indicador simples) =====
    function setConn(isOnline){
      $("connTxt").textContent = isOnline ? "Online" : "Offline";
      const pill = $("connPill");
      pill.querySelector(".dot").className = "dot " + (isOnline ? "good" : "bad");
    }
    window.addEventListener("online", ()=> setConn(true));
    window.addEventListener("offline", ()=> setConn(false));
    setConn(navigator.onLine);
  </script>
</body>
</html>
