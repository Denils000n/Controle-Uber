<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ContUber</title>

  <!-- Favicon: coloque o .ico na raiz do repo (mesmo n√≠vel do index.html) -->
  <link rel="icon" type="image/x-icon" href="favicon_contuber_full.ico" />

  <style>
    :root{
      --bg:#0b0b10;
      --panel:#12131b;
      --panel2:#161827;
      --muted:#9aa3b2;
      --text:#eef2ff;
      --line:#262a3d;
      --accent:#ff8a00;
      --ok:#2ecc71;
      --warn:#f1c40f;
      --bad:#ff4d4d;
      --btn:#2a2e44;
      --shadow:0 12px 40px rgba(0,0,0,.45);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(1000px 600px at 20% 10%, rgba(255,138,0,.08), transparent 60%),
                 radial-gradient(900px 500px at 80% 20%, rgba(120,90,255,.10), transparent 55%),
                 var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{max-width:1180px; margin:0 auto; padding:28px 16px 44px;}
    .topbar{display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:18px;}
    .brand h1{margin:0; font-size:28px; letter-spacing:.2px;}
    .brand .sub{margin-top:4px; font-size:12px; color:var(--muted)}
    .rightTop{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.06);
      color:var(--text);
      font-size:12px;
      backdrop-filter: blur(6px);
    }
    .dot{width:9px;height:9px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:16px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} .rightTop{justify-content:flex-start}}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.06);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:16px 16px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .cardHeader h2{margin:0; font-size:18px}
    .cardBody{padding:16px}
    .muted{color:var(--muted); font-size:12px; line-height:1.35}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 720px){ .row{grid-template-columns:1fr} }
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{border-color:rgba(255,138,0,.55)}
    textarea{min-height:78px; resize:vertical}
    .btns{display:flex; gap:10px; flex-wrap:wrap}
    button{
      border:none; cursor:pointer;
      padding:10px 14px;
      border-radius:12px;
      font-weight:700;
      background:var(--btn);
      color:var(--text);
    }
    button.primary{background:var(--accent); color:#14100b}
    button.danger{background:#7a1f1f}
    button.ghost{background:transparent; border:1px solid rgba(255,255,255,.14)}
    button:disabled{opacity:.6; cursor:not-allowed}
    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.25);
      font-size:12px;
      white-space:pre-wrap;
    }
    .msg.ok{border-color:rgba(46,204,113,.35); background:rgba(46,204,113,.08)}
    .msg.bad{border-color:rgba(255,77,77,.35); background:rgba(255,77,77,.08)}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{border-color:rgba(255,138,0,.55); background:rgba(255,138,0,.12)}
    .hr{height:1px; background:rgba(255,255,255,.08); margin:14px 0}
    .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
    @media (max-width: 980px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    .kpi{
      padding:12px;
      border-radius:14px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
    }
    .kpi .t{font-size:11px;color:var(--muted)}
    .kpi .v{margin-top:6px;font-size:16px;font-weight:800}
    .table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.18);
    }
    .table th,.table td{
      text-align:left;
      padding:10px 10px;
      font-size:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:top;
    }
    .table th{color:var(--muted); font-weight:700}
    .right{text-align:right}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      font-size:12px;
    }
    .pill.ok{border-color:rgba(46,204,113,.35); background:rgba(46,204,113,.08)}
    .pill.warn{border-color:rgba(241,196,15,.35); background:rgba(241,196,15,.08)}
    .pill.bad{border-color:rgba(255,77,77,.35); background:rgba(255,77,77,.08)}
    .footnote{margin-top:10px; font-size:11px; color:var(--muted)}
    .hide{display:none !important}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <h1>ContUber</h1>
        <div class="sub">Controle por fechamento (dia do carro) + seguro ‚Ä¢ login + Firestore</div>
      </div>
      <div class="rightTop" id="topChips"></div>
    </div>

    <div class="grid">

      <!-- ESQUERDA: LOGIN / APP -->
      <div class="card" id="leftCard">

        <div class="cardHeader">
          <div>
            <h2 id="leftTitle">Login</h2>
            <div class="muted" id="leftSub">Entre ou crie sua conta. No primeiro login, voc√™ configura os dados base.</div>
          </div>
          <div class="tabs hide" id="tabs">
            <div class="tab active" data-tab="dia">Dia</div>
            <div class="tab" data-tab="relatorio">Relat√≥rio</div>
            <div class="tab" data-tab="config">Config</div>
          </div>
        </div>

        <div class="cardBody">

          <!-- LOGIN -->
          <div id="loginView">
            <div class="row">
              <div>
                <label>Email</label>
                <input id="email" type="email" placeholder="seuemail@gmail.com" autocomplete="email">
              </div>
              <div>
                <label>Senha (m√≠n. 6)</label>
                <input id="senha" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
              </div>
            </div>
            <div class="btns" style="margin-top:10px">
              <button class="primary" id="btnEntrar">Entrar</button>
              <button id="btnCadastrar">Cadastrar</button>
              <button class="ghost" id="btnLimpar">Limpar</button>
            </div>
            <div class="msg hide" id="loginMsg"></div>

            <div class="footnote">
              Se aparecer <b>auth/api-key-not-valid</b>, o problema √© o <b>firebaseConfig</b> do app Web.
              Use o config do Firebase Console (Config do SDK ‚Üí ‚ÄúConfig‚Äù) e n√£o a chave ‚ÄúBrowser key‚Äù do Google Cloud.
            </div>
          </div>

          <!-- APP -->
          <div id="appView" class="hide">

            <!-- DIA -->
            <div id="tab_dia">
              <div class="row">
                <div>
                  <label>Data</label>
                  <input id="diaData" type="date">
                </div>
                <div>
                  <label>Meta di√°ria (R$)</label>
                  <input id="diaMeta" type="number" step="0.01" placeholder="200">
                </div>
              </div>

              <div class="hr"></div>

              <div class="row">
                <div>
                  <label>Ganhos do dia (Bruto) R$</label>
                  <input id="diaBruto" type="number" step="0.01" placeholder="0">
                </div>
                <div>
                  <label>Horas trabalhadas</label>
                  <input id="diaHoras" type="number" step="0.1" placeholder="0">
                </div>
              </div>

              <div class="row">
                <div>
                  <label>KM rodados</label>
                  <input id="diaKm" type="number" step="0.1" placeholder="0">
                </div>
                <div>
                  <label>M√©dia do carro (km/L) (opcional)</label>
                  <input id="diaKmL" type="number" step="0.1" placeholder="Ex.: 10.5">
                </div>
              </div>

              <div class="hr"></div>

              <div class="row">
                <div>
                  <label>Combust√≠vel (R$)</label>
                  <input id="diaCombR" type="number" step="0.01" placeholder="0">
                </div>
                <div>
                  <label>Combust√≠vel (litros)</label>
                  <input id="diaCombL" type="number" step="0.01" placeholder="0">
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Alimenta√ß√£o (R$)</label>
                  <input id="diaAlim" type="number" step="0.01" placeholder="0">
                </div>
                <div>
                  <label>Reserva manuten√ß√£o (R$)</label>
                  <input id="diaManut" type="number" step="0.01" placeholder="0">
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Outros gastos (R$)</label>
                  <input id="diaOutros" type="number" step="0.01" placeholder="0">
                </div>
                <div>
                  <label>Observa√ß√µes</label>
                  <input id="diaObs" type="text" placeholder="opcional">
                </div>
              </div>

              <div class="hr"></div>

              <div class="row">
                <div>
                  <label><input id="diaSeguroPago" type="checkbox"> Marcar seguro pago hoje</label>
                  <div class="muted">Usa o valor do seguro definido no Setup/Config.</div>
                </div>
                <div>
                  <label><input id="diaParcelaPaga" type="checkbox"> Marcar parcela paga hoje</label>
                  <div class="muted">Reduz ‚Äúparcelas restantes‚Äù se ainda houver.</div>
                </div>
              </div>

              <div class="row">
                <div>
                  <label><input id="diaAplicarFin" type="checkbox"> Aplicar l√≠quido ao financiamento</label>
                  <div class="muted">Se ligado, ao salvar o dia o saldo do financiamento diminui pelo <b>l√≠quido</b> do dia (at√© zerar).</div>
                </div>
                <div></div>
              </div>

              <div class="hr"></div>

              <div class="kpis" id="kpisDia">
                <div class="kpi"><div class="t">L√≠quido do dia</div><div class="v" id="k_liq_dia">‚Äî</div></div>
                <div class="kpi"><div class="t">Custo por km</div><div class="v" id="k_custo_km">‚Äî</div></div>
                <div class="kpi"><div class="t">R$ por hora</div><div class="v" id="k_r_hora">‚Äî</div></div>
                <div class="kpi"><div class="t">R$ por km</div><div class="v" id="k_r_km">‚Äî</div></div>
              </div>

              <div class="btns" style="margin-top:12px">
                <button class="primary" id="btnSalvarDia">Salvar dia</button>
                <button class="ghost" id="btnCarregarDia">Carregar dia</button>
                <button class="danger" id="btnSair">Sair</button>
              </div>

              <div class="msg hide" id="appMsg"></div>
            </div>

            <!-- RELATORIO -->
            <div id="tab_relatorio" class="hide">
              <div class="muted" id="relInfo">‚Äî</div>
              <div class="hr"></div>

              <div class="kpis">
                <div class="kpi"><div class="t">Bruto do ciclo</div><div class="v" id="r_bruto">‚Äî</div></div>
                <div class="kpi"><div class="t">L√≠quido do ciclo</div><div class="v" id="r_liquido">‚Äî</div></div>
                <div class="kpi"><div class="t">Combust√≠vel (R$)</div><div class="v" id="r_comb">‚Äî</div></div>
                <div class="kpi"><div class="t">KM no ciclo</div><div class="v" id="r_km">‚Äî</div></div>
              </div>

              <div class="kpis" style="margin-top:10px">
                <div class="kpi"><div class="t">R$ por km (ciclo)</div><div class="v" id="r_r_km">‚Äî</div></div>
                <div class="kpi"><div class="t">R$ por hora (ciclo)</div><div class="v" id="r_r_hora">‚Äî</div></div>
                <div class="kpi"><div class="t">Custo por km (ciclo)</div><div class="v" id="r_custo_km">‚Äî</div></div>
                <div class="kpi"><div class="t">Consumo m√©dio (km/L)</div><div class="v" id="r_kml">‚Äî</div></div>
              </div>

              <div class="hr"></div>
              <div class="btns">
                <button class="primary" id="btnGerarRel">Gerar relat√≥rio do ciclo</button>
              </div>

              <div class="hr"></div>
              <table class="table" id="relTable">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th class="right">Bruto</th>
                    <th class="right">L√≠quido</th>
                    <th class="right">KM</th>
                    <th class="right">Horas</th>
                    <th class="right">Comb R$</th>
                    <th>Pagamentos</th>
                  </tr>
                </thead>
                <tbody id="relTbody">
                  <tr><td colspan="7" class="muted">Clique em ‚ÄúGerar relat√≥rio do ciclo‚Äù.</td></tr>
                </tbody>
              </table>
              <div class="footnote">O ciclo √© definido pelo <b>dia do carro</b> (fechamento). Ex.: dia 21 ‚Üí ciclo fecha todo m√™s no dia 21.</div>
            </div>

            <!-- CONFIG -->
            <div id="tab_config" class="hide">
              <div class="row">
                <div>
                  <label>Dia do carro (fechamento)</label>
                  <input id="cfgDiaCarro" type="number" min="1" max="28" step="1">
                </div>
                <div>
                  <label>Meta di√°ria padr√£o (R$)</label>
                  <input id="cfgMeta" type="number" step="0.01">
                </div>
              </div>

              <div class="hr"></div>

              <div class="row">
                <div>
                  <label>Seguro (R$)</label>
                  <input id="cfgSeguroValor" type="number" step="0.01">
                </div>
                <div>
                  <label>Dia do seguro</label>
                  <input id="cfgDiaSeguro" type="number" min="1" max="28" step="1">
                </div>
              </div>

              <div class="hr"></div>

              <div class="row">
                <div>
                  <label>Financiado (valor total inicial) R$</label>
                  <input id="cfgFinTotal" type="number" step="0.01">
                </div>
                <div>
                  <label>Saldo do financiamento (R$)</label>
                  <input id="cfgFinSaldo" type="number" step="0.01">
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Parcelas (quantidade)</label>
                  <input id="cfgParcQtd" type="number" step="1" min="0">
                </div>
                <div>
                  <label>Valor da parcela (R$)</label>
                  <input id="cfgParcValor" type="number" step="0.01" min="0">
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Parcelas pagas (at√© agora)</label>
                  <input id="cfgParcPagas" type="number" step="1" min="0">
                </div>
                <div>
                  <label><input id="cfgAplicarFinPadrao" type="checkbox"> Aplicar l√≠quido ao financiamento (padr√£o)</label>
                  <div class="muted">Se ligado, o checkbox no ‚ÄúDia‚Äù j√° vem marcado.</div>
                </div>
              </div>

              <div class="hr"></div>
              <div class="btns">
                <button class="primary" id="btnSalvarCfg">Salvar Config</button>
              </div>

              <div class="msg hide" id="cfgMsg"></div>

              <div class="footnote">
                Dica: use dia do carro e dia do seguro at√© 28 para evitar meses com 29/30/31.
              </div>
            </div>

          </div>

        </div>
      </div>

      <!-- DIREITA: STATUS R√ÅPIDO -->
      <div class="card" id="rightCard">
        <div class="cardHeader">
          <div>
            <h2>Status r√°pido</h2>
            <div class="muted" id="statusUser">N√£o logado</div>
          </div>
        </div>
        <div class="cardBody">

          <div class="kpis">
            <div class="kpi"><div class="t">Saldo financiamento</div><div class="v" id="s_finSaldo">‚Äî</div></div>
            <div class="kpi"><div class="t">Parcelas restantes</div><div class="v" id="s_parcRest">‚Äî</div></div>
            <div class="kpi"><div class="t">Parcela (valor)</div><div class="v" id="s_parcValor">‚Äî</div></div>
            <div class="kpi"><div class="t">Status relat√≥rio</div><div class="v" id="s_relStatus">‚Äî</div></div>
          </div>

          <div class="hr"></div>

          <div class="muted">
            <div id="alertsBox"></div>
          </div>

          <div class="hr"></div>

          <div class="kpis">
            <div class="kpi"><div class="t">Bruto total</div><div class="v" id="s_brutoTotal">‚Äî</div></div>
            <div class="kpi"><div class="t">L√≠quido total</div><div class="v" id="s_liqTotal">‚Äî</div></div>
            <div class="kpi"><div class="t">Bruto hoje</div><div class="v" id="s_brutoHoje">‚Äî</div></div>
            <div class="kpi"><div class="t">L√≠quido hoje</div><div class="v" id="s_liqHoje">‚Äî</div></div>
          </div>

          <div class="footnote">
            Se o favicon der 404, confirme se <b>favicon_contuber_full.ico</b> est√° na raiz do reposit√≥rio e o nome est√° id√™ntico (mai√∫sculas/min√∫sculas contam).
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- Firebase (SDK modular via CDN) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, setDoc, updateDoc,
      collection, getDocs, query, where
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ‚úÖ Seu firebaseConfig (do Firebase Console ‚Üí App Web ‚Üí Config do SDK ‚Üí Config)
    const firebaseConfig = {
      apiKey: "AIzaSyAZCCTQvKNn94cdJdsL-ceZNR87gwoQhKg",
      authDomain: "contuber-1c9ca.firebaseapp.com",
      projectId: "contuber-1c9ca",
      storageBucket: "contuber-1c9ca.firebasestorage.app",
      messagingSenderId: "333645182595",
      appId: "1:333645182595:web:147d3ad84116b595324db6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);
    const money = (v) => (Number(v || 0)).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    const n = (v) => Number(String(v ?? "").replace(",", ".")) || 0;
    const clampDay = (d) => Math.max(1, Math.min(28, Math.floor(n(d) || 1)));

    function isoToday(){
      const d = new Date();
      return d.toISOString().slice(0,10);
    }

    function parseISO(s){
      const [y,m,d] = s.split("-").map(x=>parseInt(x,10));
      return new Date(y, m-1, d);
    }

    function fmtDateBR(iso){
      const d = parseISO(iso);
      return d.toLocaleDateString("pt-BR");
    }

    function addDays(date, delta){
      const d = new Date(date.getTime());
      d.setDate(d.getDate()+delta);
      return d;
    }

    function isoFromDate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }

    // ciclo baseado no dia do carro (fechamento)
    function calcCycle(todayDate, carCloseDay){
      const closeDay = clampDay(carCloseDay);
      const y = todayDate.getFullYear();
      const m = todayDate.getMonth(); // 0-11
      const day = todayDate.getDate();

      // √∫ltimo fechamento <= hoje
      let close = new Date(y, m, closeDay);
      if(day < closeDay){
        close = new Date(y, m-1, closeDay);
      }

      const prevClose = new Date(close.getFullYear(), close.getMonth()-1, closeDay);
      const start = addDays(prevClose, 1);
      const end = close;

      const available = todayDate >= end;
      return {
        startISO: isoFromDate(start),
        endISO: isoFromDate(end),
        closeDay,
        available
      };
    }

    function setMsg(el, text, kind){
      el.classList.remove("hide","ok","bad");
      el.classList.add(kind === "ok" ? "ok" : "bad");
      el.textContent = text;
    }
    function clearMsg(el){ el.classList.add("hide"); el.textContent=""; el.classList.remove("ok","bad"); }

    // ---------- UI refs ----------
    const loginView = $("loginView");
    const appView = $("appView");
    const tabs = $("tabs");
    const loginMsg = $("loginMsg");
    const appMsg = $("appMsg");
    const cfgMsg = $("cfgMsg");

    // ---------- Data model ----------
    const profileRef = (uid) => doc(db, "users", uid, "profile", "main");
    const dayRef = (uid, iso) => doc(db, "users", uid, "days", iso);

    function defaultProfile(){
      return {
        setupCompleted: false,

        // base config
        carCloseDay: 21,
        insuranceDay: 15,
        insuranceValue: 0,
        metaDaily: 200,

        financedTotal: 0,
        financeBalance: 0,

        installmentCount: 0,
        installmentValue: 0,
        installmentPaid: 0,

        applyNetToFinanceDefault: false,

        // totals
        totals: {
          bruto: 0,
          liquido: 0,
          km: 0,
          horas: 0,
          combR: 0,
          combL: 0,
          alim: 0,
          manut: 0,
          outros: 0,
          segurosPagos: 0,
          parcelasPagas: 0
        }
      };
    }

    let currentUser = null;
    let profileCache = null;

    // ---------- Auth actions ----------
    $("btnEntrar").addEventListener("click", async () => {
      clearMsg(loginMsg);
      try{
        await signInWithEmailAndPassword(auth, $("email").value.trim(), $("senha").value);
      }catch(e){
        setMsg(loginMsg, `Erro: ${e.code || e.message}`, "bad");
      }
    });

    $("btnCadastrar").addEventListener("click", async () => {
      clearMsg(loginMsg);
      try{
        await createUserWithEmailAndPassword(auth, $("email").value.trim(), $("senha").value);
      }catch(e){
        setMsg(loginMsg, `Erro: ${e.code || e.message}`, "bad");
      }
    });

    $("btnLimpar").addEventListener("click", () => {
      $("email").value="";
      $("senha").value="";
      clearMsg(loginMsg);
    });

    $("btnSair").addEventListener("click", async() => {
      await signOut(auth);
    });

    // ---------- Tabs ----------
    function showTab(name){
      const map = ["dia","relatorio","config"];
      map.forEach(t=>{
        $("tab_"+t).classList.toggle("hide", t!==name);
        const el = document.querySelector(`.tab[data-tab="${t}"]`);
        if(el) el.classList.toggle("active", t===name);
      });
      clearMsg(appMsg);
      clearMsg(cfgMsg);
    }

    tabs.addEventListener("click",(e)=>{
      const t = e.target?.dataset?.tab;
      if(!t) return;
      showTab(t);
      if(t==="relatorio"){
        // auto atualiza status do ciclo (sem carregar dados ainda)
        renderStatus();
      }
      if(t==="config"){
        fillConfigFromProfile();
      }
    });

    // ---------- Profile load/init ----------
    async function loadOrInitProfile(uid){
      const ref = profileRef(uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        const p = defaultProfile();
        await setDoc(ref, p, {merge:true});
        return p;
      }
      // merge defensivo
      const base = defaultProfile();
      const p = snap.data();
      // deep-ish merge simples
      p.totals = Object.assign({}, base.totals, p.totals || {});
      return Object.assign({}, base, p);
    }

    function fillConfigFromProfile(){
      if(!profileCache) return;
      $("cfgDiaCarro").value = profileCache.carCloseDay ?? 21;
      $("cfgMeta").value = profileCache.metaDaily ?? 200;
      $("cfgSeguroValor").value = profileCache.insuranceValue ?? 0;
      $("cfgDiaSeguro").value = profileCache.insuranceDay ?? 15;
      $("cfgFinTotal").value = profileCache.financedTotal ?? 0;
      $("cfgFinSaldo").value = profileCache.financeBalance ?? 0;
      $("cfgParcQtd").value = profileCache.installmentCount ?? 0;
      $("cfgParcValor").value = profileCache.installmentValue ?? 0;
      $("cfgParcPagas").value = profileCache.installmentPaid ?? 0;
      $("cfgAplicarFinPadrao").checked = !!profileCache.applyNetToFinanceDefault;
    }

    $("btnSalvarCfg").addEventListener("click", async ()=>{
      clearMsg(cfgMsg);
      if(!currentUser) return;

      const upd = {
        setupCompleted: true,
        carCloseDay: clampDay($("cfgDiaCarro").value),
        insuranceDay: clampDay($("cfgDiaSeguro").value),
        insuranceValue: n($("cfgSeguroValor").value),
        metaDaily: n($("cfgMeta").value),

        financedTotal: n($("cfgFinTotal").value),
        financeBalance: Math.max(0, n($("cfgFinSaldo").value)),

        installmentCount: Math.max(0, Math.floor(n($("cfgParcQtd").value))),
        installmentValue: Math.max(0, n($("cfgParcValor").value)),
        installmentPaid: Math.max(0, Math.floor(n($("cfgParcPagas").value))),

        applyNetToFinanceDefault: !!$("cfgAplicarFinPadrao").checked
      };

      // garante paid <= count
      if(upd.installmentPaid > upd.installmentCount) upd.installmentPaid = upd.installmentCount;

      try{
        await updateDoc(profileRef(currentUser.uid), upd);
        profileCache = Object.assign({}, profileCache, upd);
        setMsg(cfgMsg, "Config salva com sucesso!", "ok");
        // atualiza meta no dia
        $("diaMeta").value = profileCache.metaDaily ?? 0;
        $("diaAplicarFin").checked = !!profileCache.applyNetToFinanceDefault;
        renderStatus();
        renderTopChips();
      }catch(e){
        setMsg(cfgMsg, `Erro ao salvar config: ${e.code || e.message}`, "bad");
      }
    });

    // ---------- Daily calculations ----------
    function calcLiquido(bruto, combR, alim, manut, outros, seguroPago, parcelaPaga){
      const seguro = seguroPago ? n(profileCache?.insuranceValue) : 0;
      const parcela = parcelaPaga ? n(profileCache?.installmentValue) : 0;
      const gastos = combR + alim + manut + outros + seguro + parcela;
      return { gastos, seguro, parcela, liquido: bruto - gastos };
    }

    function updateKpisPreview(){
      if(!profileCache) return;

      const bruto = n($("diaBruto").value);
      const horas = n($("diaHoras").value);
      const km = n($("diaKm").value);
      const combR = n($("diaCombR").value);
      const combL = n($("diaCombL").value);
      const alim = n($("diaAlim").value);
      const manut = n($("diaManut").value);
      const outros = n($("diaOutros").value);
      const seguroPago = $("diaSeguroPago").checked;
      const parcelaPaga = $("diaParcelaPaga").checked;

      const {gastos, liquido} = calcLiquido(bruto, combR, alim, manut, outros, seguroPago, parcelaPaga);

      $("k_liq_dia").textContent = money(liquido);

      const custoKm = km > 0 ? (gastos / km) : 0;
      const rHora = horas > 0 ? (bruto / horas) : 0;
      const rKm = km > 0 ? (bruto / km) : 0;

      $("k_custo_km").textContent = km > 0 ? money(custoKm) : "‚Äî";
      $("k_r_hora").textContent = horas > 0 ? money(rHora) : "‚Äî";
      $("k_r_km").textContent = km > 0 ? money(rKm) : "‚Äî";

      // atualiza chip de meta (dia)
      const meta = n($("diaMeta").value || profileCache.metaDaily);
      const top = $("topChips");
      const metaChip = top.querySelector('[data-chip="metaHoje"]');
      if(metaChip){
        const ok = bruto >= meta && meta > 0;
        metaChip.innerHTML = `<span class="dot ${ok ? "ok":"bad"}"></span>Meta di√°ria: ${money(meta)}`;
      }
    }

    ["diaBruto","diaHoras","diaKm","diaCombR","diaCombL","diaAlim","diaManut","diaOutros","diaMeta"]
      .forEach(id=> $(id).addEventListener("input", updateKpisPreview));
    ["diaSeguroPago","diaParcelaPaga"].forEach(id=> $(id).addEventListener("change", updateKpisPreview));

    // ---------- Load day ----------
    $("btnCarregarDia").addEventListener("click", async ()=>{
      clearMsg(appMsg);
      if(!currentUser) return;

      const iso = $("diaData").value || isoToday();
      try{
        const snap = await getDoc(dayRef(currentUser.uid, iso));
        if(!snap.exists()){
          setMsg(appMsg, "Sem dados para esta data. Preencha e clique em Salvar dia.", "ok");
          updateKpisPreview();
          return;
        }
        const d = snap.data();
        $("diaBruto").value = d.bruto ?? 0;
        $("diaHoras").value = d.horas ?? 0;
        $("diaKm").value = d.km ?? 0;
        $("diaKmL").value = d.kmL ?? "";
        $("diaCombR").value = d.combR ?? 0;
        $("diaCombL").value = d.combL ?? 0;
        $("diaAlim").value = d.alim ?? 0;
        $("diaManut").value = d.manut ?? 0;
        $("diaOutros").value = d.outros ?? 0;
        $("diaObs").value = d.obs ?? "";
        $("diaSeguroPago").checked = !!d.seguroPago;
        $("diaParcelaPaga").checked = !!d.parcelaPaga;
        $("diaAplicarFin").checked = !!d.aplicarFin;
        setMsg(appMsg, `Dados carregados: ${fmtDateBR(iso)}`, "ok");
        updateKpisPreview();
      }catch(e){
        setMsg(appMsg, `Erro ao carregar dia: ${e.code || e.message}`, "bad");
      }
    });

    // ---------- Save day with DELTA (avoid double counting) ----------
    $("btnSalvarDia").addEventListener("click", async ()=>{
      clearMsg(appMsg);
      if(!currentUser || !profileCache) return;

      const iso = $("diaData").value || isoToday();
      $("diaData").value = iso;

      const bruto = n($("diaBruto").value);
      const horas = n($("diaHoras").value);
      const km = n($("diaKm").value);
      const kmL = $("diaKmL").value ? n($("diaKmL").value) : null;

      const combR = n($("diaCombR").value);
      const combL = n($("diaCombL").value);
      const alim = n($("diaAlim").value);
      const manut = n($("diaManut").value);
      const outros = n($("diaOutros").value);

      const seguroPago = $("diaSeguroPago").checked;
      const parcelaPaga = $("diaParcelaPaga").checked;
      const aplicarFin = $("diaAplicarFin").checked;
      const obs = $("diaObs").value?.trim() || "";

      // calcula
      const c = calcLiquido(bruto, combR, alim, manut, outros, seguroPago, parcelaPaga);
      const liquido = c.liquido;

      try{
        // l√™ anterior para delta
        const ref = dayRef(currentUser.uid, iso);
        const prevSnap = await getDoc(ref);
        const prev = prevSnap.exists() ? prevSnap.data() : {};

        // recomputa prev liquido (para delta correto)
        const prevC = calcLiquido(
          n(prev.bruto), n(prev.combR), n(prev.alim), n(prev.manut), n(prev.outros),
          !!prev.seguroPago, !!prev.parcelaPaga
        );

        const delta = {
          bruto: bruto - n(prev.bruto),
          liquido: liquido - n(prevC.liquido),
          km: km - n(prev.km),
          horas: horas - n(prev.horas),
          combR: combR - n(prev.combR),
          combL: combL - n(prev.combL),
          alim: alim - n(prev.alim),
          manut: manut - n(prev.manut),
          outros: outros - n(prev.outros),
          segurosPagos: (seguroPago ? 1:0) - (prev.seguroPago ? 1:0),
          parcelasPagas: (parcelaPaga ? 1:0) - (prev.parcelaPaga ? 1:0)
        };

        // salva o dia (merge)
        await setDoc(ref, {
          data: iso,
          bruto, horas, km, kmL,
          combR, combL, alim, manut, outros,
          obs,
          seguroPago, parcelaPaga, aplicarFin
        }, {merge:true});

        // atualiza totals no profile (delta)
        const totals = Object.assign({}, profileCache.totals);
        totals.bruto += delta.bruto;
        totals.liquido += delta.liquido;
        totals.km += delta.km;
        totals.horas += delta.horas;
        totals.combR += delta.combR;
        totals.combL += delta.combL;
        totals.alim += delta.alim;
        totals.manut += delta.manut;
        totals.outros += delta.outros;
        totals.segurosPagos += delta.segurosPagos;
        totals.parcelasPagas += delta.parcelasPagas;

        // parcelas: se marcar parcela paga hoje e antes n√£o estava
        let installmentPaid = profileCache.installmentPaid || 0;
        if(delta.parcelasPagas === 1){
          installmentPaid = Math.min((profileCache.installmentCount||0), installmentPaid + 1);
        }else if(delta.parcelasPagas === -1){
          installmentPaid = Math.max(0, installmentPaid - 1);
        }

        // financiamento: aplicar liquido (delta liquido) s√≥ se aplicarFin true
        let financeBalance = Math.max(0, n(profileCache.financeBalance));
        // regra: se aplicarFin no dia atual, reduz pelo delta do liquido (e n√£o pelo bruto)
        // e se desmarcar aplicarFin, devolve (aplica√ß√£o inversa) com base no prev aplicarFin.
        const prevAplicar = !!prev.aplicarFin;
        if(aplicarFin && !prevAplicar){
          financeBalance = Math.max(0, financeBalance - Math.max(0, liquido));
        }
        if(!aplicarFin && prevAplicar){
          // devolve o que tinha aplicado antes (prev liquido positivo)
          financeBalance = financeBalance + Math.max(0, prevC.liquido);
        }
        // se aplicarFin permanece true e o l√≠quido mudou (edi√ß√£o), ajusta diferen√ßa:
        if(aplicarFin && prevAplicar){
          const diff = Math.max(0, liquido) - Math.max(0, prevC.liquido);
          financeBalance = Math.max(0, financeBalance - diff);
        }

        await updateDoc(profileRef(currentUser.uid), {
          setupCompleted: true,
          totals,
          installmentPaid,
          financeBalance,
          metaDaily: n($("diaMeta").value || profileCache.metaDaily || 0)
        });

        // cache
        profileCache.totals = totals;
        profileCache.installmentPaid = installmentPaid;
        profileCache.financeBalance = financeBalance;
        profileCache.metaDaily = n($("diaMeta").value || profileCache.metaDaily || 0);

        setMsg(appMsg, `Dia salvo!\nBruto: ${money(bruto)}\nGastos: ${money(c.gastos)}\nL√≠quido: ${money(liquido)}`, "ok");
        updateKpisPreview();
        renderTopChips();
        renderStatus();
      }catch(e){
        setMsg(appMsg, `Erro ao salvar: ${e.code || e.message}`, "bad");
      }
    });

    // ---------- Report ----------
    $("btnGerarRel").addEventListener("click", async ()=>{
      if(!currentUser || !profileCache) return;

      const todayDate = new Date();
      const cy = calcCycle(todayDate, profileCache.carCloseDay);
      $("relInfo").textContent = `Ciclo: ${fmtDateBR(cy.startISO)} ‚Üí ${fmtDateBR(cy.endISO)} (fechamento dia ${cy.closeDay}).`;

      const q = query(
        collection(db, "users", currentUser.uid, "days"),
        where("data", ">=", cy.startISO),
        where("data", "<=", cy.endISO)
      );

      try{
        const snap = await getDocs(q);
        const rows = [];
        snap.forEach(docu=> rows.push(docu.data()));
        rows.sort((a,b)=> String(a.data).localeCompare(String(b.data)));

        if(rows.length === 0){
          $("relTbody").innerHTML = `<tr><td colspan="7" class="muted">Sem lan√ßamentos no ciclo.</td></tr>`;
        }else{
          const tr = rows.map(r=>{
            const bruto = n(r.bruto);
            const horas = n(r.horas);
            const km = n(r.km);
            const combR = n(r.combR);
            const combL = n(r.combL);
            const alim = n(r.alim);
            const manut = n(r.manut);
            const outros = n(r.outros);
            const seguroPago = !!r.seguroPago;
            const parcelaPaga = !!r.parcelaPaga;

            const c = calcLiquido(bruto, combR, alim, manut, outros, seguroPago, parcelaPaga);
            const pagos = [
              seguroPago ? `<span class="pill ok">Seguro</span>` : ``,
              parcelaPaga ? `<span class="pill warn">Parcela</span>` : ``
            ].filter(Boolean).join(" ");

            return `
              <tr>
                <td>${fmtDateBR(r.data)}</td>
                <td class="right">${money(bruto)}</td>
                <td class="right">${money(c.liquido)}</td>
                <td class="right">${km ? km.toFixed(1) : "0.0"}</td>
                <td class="right">${horas ? horas.toFixed(1) : "0.0"}</td>
                <td class="right">${money(combR)}</td>
                <td>${pagos || `<span class="muted">‚Äî</span>`}</td>
              </tr>
            `;
          }).join("");
          $("relTbody").innerHTML = tr;
        }

        // agregados ciclo
        const agg = rows.reduce((acc,r)=>{
          const bruto = n(r.bruto);
          const horas = n(r.horas);
          const km = n(r.km);
          const combR = n(r.combR);
          const combL = n(r.combL);
          const alim = n(r.alim);
          const manut = n(r.manut);
          const outros = n(r.outros);
          const c = calcLiquido(bruto, combR, alim, manut, outros, !!r.seguroPago, !!r.parcelaPaga);

          acc.bruto += bruto;
          acc.liquido += c.liquido;
          acc.gastos += c.gastos;
          acc.km += km;
          acc.horas += horas;
          acc.combR += combR;
          acc.combL += combL;
          return acc;
        }, {bruto:0, liquido:0, gastos:0, km:0, horas:0, combR:0, combL:0});

        $("r_bruto").textContent = money(agg.bruto);
        $("r_liquido").textContent = money(agg.liquido);
        $("r_comb").textContent = money(agg.combR);
        $("r_km").textContent = agg.km ? agg.km.toFixed(1) : "0.0";

        $("r_r_km").textContent = agg.km>0 ? money(agg.bruto/agg.km) : "‚Äî";
        $("r_r_hora").textContent = agg.horas>0 ? money(agg.bruto/agg.horas) : "‚Äî";
        $("r_custo_km").textContent = agg.km>0 ? money(agg.gastos/agg.km) : "‚Äî";
        $("r_kml").textContent = agg.combL>0 ? (agg.km/agg.combL).toFixed(2) : "‚Äî";

        renderStatus(); // atualiza status relat√≥rio
      }catch(e){
        $("relTbody").innerHTML = `<tr><td colspan="7" class="muted">Erro: ${e.code || e.message}</td></tr>`;
      }
    });

    // ---------- Status + Chips ----------
    function renderTopChips(){
      const box = $("topChips");
      box.innerHTML = "";

      if(!currentUser || !profileCache){
        box.innerHTML = `<span class="chip"><span class="dot warn"></span>Offline</span>`;
        return;
      }

      const todayIso = isoToday();
      const carDay = clampDay(profileCache.carCloseDay);
      const insDay = clampDay(profileCache.insuranceDay);
      const finSaldo = Math.max(0, n(profileCache.financeBalance));
      const meta = n(profileCache.metaDaily);

      // bruto/liquido hoje (carrega do cache do DOM se existir)
      const brutoHoje = n($("diaBruto").value);
      // recompute with current fields
      const c = calcLiquido(
        brutoHoje,
        n($("diaCombR").value),
        n($("diaAlim").value),
        n($("diaManut").value),
        n($("diaOutros").value),
        $("diaSeguroPago").checked,
        $("diaParcelaPaga").checked
      );

      // chips:
      const now = new Date();
      const day = now.getDate();
      const alertaCarro = day === carDay;
      const alertaSeguro = day === insDay;

      const totals = profileCache.totals || {};
      box.appendChild(chip(alertaCarro ? "warn":"ok", `Fechamento carro: dia ${carDay}`));
      box.appendChild(chip(alertaSeguro ? "warn":"ok", `Seguro: dia ${insDay} (${money(profileCache.insuranceValue)})`));
      box.appendChild(chip(finSaldo>0 ? "bad":"ok", `Saldo financiamento: ${money(finSaldo)}`));
      const metaOk = meta>0 ? (brutoHoje >= meta) : false;
      const metaChip = chip(metaOk ? "ok":"bad", `Meta di√°ria: ${money(meta)}`);
      metaChip.setAttribute("data-chip","metaHoje");
      box.appendChild(metaChip);

      // bruto/liquido total + hoje
      box.appendChild(chip("ok", `Bruto total: ${money(totals.bruto)}`));
      box.appendChild(chip("ok", `L√≠quido total: ${money(totals.liquido)}`));
      box.appendChild(chip("ok", `Bruto hoje: ${money(brutoHoje)}`));
      box.appendChild(chip(c.liquido>=0 ? "ok":"bad", `L√≠quido hoje: ${money(c.liquido)}`));
    }

    function chip(kind, text){
      const s = document.createElement("span");
      s.className = "chip";
      const dot = document.createElement("span");
      dot.className = `dot ${kind}`;
      s.appendChild(dot);
      const t = document.createElement("span");
      t.textContent = text;
      s.appendChild(t);
      return s;
    }

    async function loadTodayDocToStatus(){
      if(!currentUser) return null;
      const iso = $("diaData").value || isoToday();
      try{
        const snap = await getDoc(dayRef(currentUser.uid, iso));
        return snap.exists() ? snap.data() : null;
      }catch{ return null; }
    }

    async function renderStatus(){
      if(!currentUser || !profileCache){
        $("statusUser").textContent = "N√£o logado";
        $("s_finSaldo").textContent = "‚Äî";
        $("s_parcRest").textContent = "‚Äî";
        $("s_parcValor").textContent = "‚Äî";
        $("s_relStatus").textContent = "‚Äî";
        $("alertsBox").innerHTML = "‚Äî";
        $("s_brutoTotal").textContent = "‚Äî";
        $("s_liqTotal").textContent = "‚Äî";
        $("s_brutoHoje").textContent = "‚Äî";
        $("s_liqHoje").textContent = "‚Äî";
        return;
      }

      $("statusUser").textContent = `Logado como: ${currentUser.email}`;

      const parcRest = Math.max(0, (profileCache.installmentCount||0) - (profileCache.installmentPaid||0));
      $("s_finSaldo").textContent = money(Math.max(0, n(profileCache.financeBalance)));
      $("s_parcRest").textContent = String(parcRest);
      $("s_parcValor").textContent = money(n(profileCache.installmentValue));

      // relat√≥rio dispon√≠vel?
      const cy = calcCycle(new Date(), profileCache.carCloseDay);
      $("s_relStatus").textContent = cy.available ? "Dispon√≠vel" : "Ainda n√£o";
      $("s_relStatus").style.color = cy.available ? "var(--ok)" : "var(--warn)";

      // alertas do dia
      const d = new Date();
      const day = d.getDate();
      const alerts = [];
      if(day === clampDay(profileCache.carCloseDay)) alerts.push(`<span class="pill warn">Hoje √© dia de pagamento do carro (fechamento)</span>`);
      if(day === clampDay(profileCache.insuranceDay)) alerts.push(`<span class="pill warn">Hoje √© dia de pagamento do seguro</span>`);
      if((profileCache.financeBalance||0) <= 0 && (profileCache.financedTotal||0) > 0) alerts.push(`<span class="pill ok">Financiamento zerado üéâ</span>`);
      $("alertsBox").innerHTML = alerts.length ? alerts.join(" ") : `<span class="pill ok">Sem alertas hoje</span>`;

      // totais + hoje
      const totals = profileCache.totals || {};
      $("s_brutoTotal").textContent = money(totals.bruto);
      $("s_liqTotal").textContent = money(totals.liquido);

      const todayDoc = await loadTodayDocToStatus();
      if(todayDoc){
        const bruto = n(todayDoc.bruto);
        const c = calcLiquido(bruto, n(todayDoc.combR), n(todayDoc.alim), n(todayDoc.manut), n(todayDoc.outros), !!todayDoc.seguroPago, !!todayDoc.parcelaPaga);
        $("s_brutoHoje").textContent = money(bruto);
        $("s_liqHoje").textContent = money(c.liquido);
      }else{
        // fallback para inputs atuais
        const bruto = n($("diaBruto").value);
        const c = calcLiquido(bruto, n($("diaCombR").value), n($("diaAlim").value), n($("diaManut").value), n($("diaOutros").value), $("diaSeguroPago").checked, $("diaParcelaPaga").checked);
        $("s_brutoHoje").textContent = money(bruto);
        $("s_liqHoje").textContent = money(c.liquido);
      }
    }

    // ---------- First login setup (auto fill config if empty) ----------
    async function ensureSetupVisible(){
      if(!profileCache) return;

      // se n√£o completou setup, manda pra aba config e avisa
      if(!profileCache.setupCompleted){
        showTab("config");
        fillConfigFromProfile();
        setMsg(cfgMsg,
`Primeiro acesso: complete o Setup na aba CONFIG.
1) Dia do carro (fechamento)
2) Dia e valor do seguro
3) Financiado + saldo (pode come√ßar igual)
4) Parcelas (qtd e valor)
Depois clique em ‚ÄúSalvar Config‚Äù.`, "ok");
      }else{
        // config ok
        $("diaMeta").value = profileCache.metaDaily ?? 0;
        $("diaAplicarFin").checked = !!profileCache.applyNetToFinanceDefault;
      }
    }

    // ---------- Auth state ----------
    onAuthStateChanged(auth, async(user)=>{
      currentUser = user;

      clearMsg(loginMsg);
      clearMsg(appMsg);
      clearMsg(cfgMsg);

      if(!user){
        profileCache = null;

        loginView.classList.remove("hide");
        appView.classList.add("hide");
        tabs.classList.add("hide");
        $("leftTitle").textContent = "Login";
        $("leftSub").textContent = "Entre ou crie sua conta. No primeiro login, voc√™ configura os dados base.";

        renderTopChips();
        renderStatus();
        return;
      }

      // logged
      profileCache = await loadOrInitProfile(user.uid);

      loginView.classList.add("hide");
      appView.classList.remove("hide");
      tabs.classList.remove("hide");
      $("leftTitle").textContent = "Painel";
      $("leftSub").textContent = "Lance o dia, acompanhe metas e gere o relat√≥rio do ciclo.";

      // default date today
      $("diaData").value = isoToday();

      // carregar config meta + default checkbox
      $("diaMeta").value = profileCache.metaDaily ?? 0;
      $("diaAplicarFin").checked = !!profileCache.applyNetToFinanceDefault;

      // tenta carregar o dia de hoje automaticamente (se existir)
      $("btnCarregarDia").click();

      // status
      renderTopChips();
      renderStatus();
      ensureSetupVisible();
      updateKpisPreview();
    });

  </script>
</body>
</html>
