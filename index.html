<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ContUber</title>

  <!-- Favicon (coloque o arquivo na raiz do repo, mesmo nível do index.html) -->
  <link rel="icon" href="favicon_contuber_full.ico" />

  <style>
    :root{
      --bg1:#050608;
      --bg2:#0b0f18;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --line: rgba(255,255,255,.12);
      --text:#e9eefc;
      --muted: rgba(233,238,252,.65);
      --accent:#ff8a00;
      --ok:#39d98a;
      --bad:#ff4d4d;
      --warn:#ffd166;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 20% 0%, rgba(255,138,0,.16), transparent 55%),
        radial-gradient(900px 500px at 85% 20%, rgba(123,97,255,.18), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1180px; margin:0 auto; padding:26px 18px 50px;}
    header{display:flex; align-items:flex-start; justify-content:space-between; gap:14px; margin-bottom:16px;}
    .brand h1{margin:0; font-size:28px; letter-spacing:.2px}
    .brand p{margin:3px 0 0; color:var(--muted); font-size:13px}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .dot{width:8px; height:8px; border-radius:50%;}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding:16px 16px 10px;
      border-bottom:1px solid rgba(255,255,255,.07);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card .head h2{margin:0; font-size:18px}
    .card .head small{color:var(--muted)}
    .card .body{padding:16px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .col{flex:1 1 240px}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input, select{
      width:100%;
      padding:12px 12px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      outline:none;
      color:var(--text);
    }
    input::placeholder{color:rgba(233,238,252,.35)}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      border:0;
      border-radius: 12px;
      padding:11px 14px;
      cursor:pointer;
      font-weight:600;
      transition: transform .06s ease, filter .2s ease;
    }
    button:active{transform: translateY(1px)}
    .primary{background:var(--accent); color:#1b1200}
    .secondary{background: rgba(255,255,255,.08); color:var(--text); border:1px solid rgba(255,255,255,.12)}
    .danger{background: rgba(255,77,77,.14); color:#ffd7d7; border:1px solid rgba(255,77,77,.28)}
    .ghost{background: transparent; color:var(--muted); border:1px solid rgba(255,255,255,.12)}
    .msg{
      margin-top:12px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color:var(--muted);
      font-size:12.5px;
      white-space:pre-wrap;
    }
    .msg.err{border-color: rgba(255,77,77,.35); background: rgba(255,77,77,.08); color:#ffd0d0}
    .msg.ok{border-color: rgba(57,217,138,.35); background: rgba(57,217,138,.08); color:#d6ffe9}
    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 980px){
      .kpis{grid-template-columns: repeat(2, 1fr);}
    }
    .kpi{
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding:10px 12px;
    }
    .kpi .t{font-size:11px; color:var(--muted)}
    .kpi .v{font-size:16px; margin-top:4px; font-weight:800}
    .bar{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:12px 16px;
      border-top:1px solid rgba(255,255,255,.07);
      background: rgba(0,0,0,.18);
    }
    .badge{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color:var(--muted);
    }
    .badge strong{color:var(--text)}
    .badge .miniDot{width:8px;height:8px;border-radius:50%;}
    .miniDot.ok{background:var(--ok)}
    .miniDot.warn{background:var(--warn)}
    .miniDot.bad{background:var(--bad)}
    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:980px){ .split{grid-template-columns:1fr} }
    .hr{height:1px; background: rgba(255,255,255,.08); margin:14px 0}
    .small{font-size:12px; color:var(--muted)}
    .mono{font-family:var(--mono)}
    .hide{display:none !important;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>ContUber</h1>
        <p>Controle mensal por fechamento (dia do carro) + seguro • login + Firestore</p>
      </div>
      <div class="pill" id="netPill"><span class="dot ok" id="netDot"></span><span id="netTxt">Online</span></div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <div class="card" id="leftCard">
        <div class="head">
          <div>
            <h2 id="leftTitle">Login</h2>
            <small id="leftSub">Entre ou crie sua conta. No primeiro login, você configura os dados base.</small>
          </div>
          <button class="danger hide" id="btnLogout">Sair</button>
        </div>

        <div class="body">
          <!-- LOGIN VIEW -->
          <div id="loginView">
            <div class="row">
              <div class="col">
                <label>Email</label>
                <input id="email" type="email" placeholder="seuemail@gmail.com" autocomplete="email" />
              </div>
              <div class="col">
                <label>Senha (mín. 6)</label>
                <input id="senha" type="password" placeholder="******" autocomplete="current-password" />
              </div>
            </div>
            <div class="btns">
              <button class="primary" id="btnEntrar">Entrar</button>
              <button class="secondary" id="btnCadastrar">Cadastrar</button>
              <button class="ghost" id="btnLimparLogin">Limpar</button>
            </div>
            <div class="msg" id="msgLogin">Dica: se aparecer “Offline”, desative o modo Offline na aba Network do DevTools e recarregue (Ctrl+Shift+R).</div>
          </div>

          <!-- SETUP VIEW -->
          <div id="setupView" class="hide">
            <div class="split">
              <div>
                <h3 style="margin:0 0 8px">Configuração inicial</h3>
                <p class="small" style="margin:0 0 12px">
                  Isso define o “fechamento do mês” e os custos fixos.
                </p>

                <div class="row">
                  <div class="col">
                    <label>Dia de fechamento/pagamento do carro (1–28)</label>
                    <input id="carCloseDay" type="number" min="1" max="28" placeholder="21" />
                  </div>
                  <div class="col">
                    <label>Meta diária (R$)</label>
                    <input id="metaDiaria" type="number" min="0" step="0.01" placeholder="200" />
                  </div>
                </div>

                <div class="row">
                  <div class="col">
                    <label>Saldo inicial do financiamento (R$)</label>
                    <input id="finSaldo" type="number" min="0" step="0.01" placeholder="137280" />
                  </div>
                  <div class="col">
                    <label>Qtd. parcelas (total)</label>
                    <input id="qtdParcelas" type="number" min="1" step="1" placeholder="48" />
                  </div>
                </div>

                <div class="row">
                  <div class="col">
                    <label>Valor da parcela (R$)</label>
                    <input id="valorParcela" type="number" min="0" step="0.01" placeholder="950" />
                  </div>
                  <div class="col">
                    <label>Parcelas já pagas</label>
                    <input id="parcelasPagas" type="number" min="0" step="1" placeholder="0" />
                  </div>
                </div>

                <div class="row">
                  <div class="col">
                    <label>Dia do seguro (1–28)</label>
                    <input id="seguroDay" type="number" min="1" max="28" placeholder="15" />
                  </div>
                  <div class="col">
                    <label>Valor do seguro (R$)</label>
                    <input id="seguroVal" type="number" min="0" step="0.01" placeholder="364" />
                  </div>
                </div>

                <div class="btns">
                  <button class="primary" id="btnSalvarSetup">Salvar configuração</button>
                  <button class="ghost" id="btnCancelarSetup">Cancelar</button>
                </div>

                <div class="msg" id="msgSetup">Após salvar, você começa a lançar seus valores diários.</div>
              </div>

              <div>
                <h3 style="margin:0 0 8px">Como funciona o mês</h3>
                <div class="msg">
• O “mês” fecha no dia do carro (ex.: 21).  
• O relatório do mês mostra do fechamento anterior até o fechamento atual.  
• O saldo do financiamento diminui quando você marca “parcela paga” ou adiciona “pagamento extra”.
                </div>
              </div>
            </div>
          </div>

          <!-- APP VIEW -->
          <div id="appView" class="hide">
            <div class="small" id="userLine">Logado como: —</div>

            <div class="bar" id="alertsBar"></div>

            <div class="split" style="margin-top:12px">
              <div>
                <h3 style="margin:0 0 10px">Lançamento do dia</h3>
                <div class="row">
                  <div class="col">
                    <label>Data</label>
                    <input id="entryDate" type="date" />
                  </div>
                  <div class="col">
                    <label>Ganho bruto do dia (R$)</label>
                    <input id="ganhoBruto" type="number" min="0" step="0.01" placeholder="0" />
                  </div>
                </div>

                <div class="row">
                  <div class="col">
                    <label>Km rodados</label>
                    <input id="km" type="number" min="0" step="0.1" placeholder="0" />
                  </div>
                  <div class="col">
                    <label>Horas trabalhadas</label>
                    <input id="horas" type="number" min="0" step="0.1" placeholder="0" />
                  </div>
                </div>

                <div class="row">
                  <div class="col">
                    <label>Combustível (R$)</label>
                    <input id="combustivelValor" type="number" min="0" step="0.01" placeholder="0" />
                  </div>
                  <div class="col">
                    <label>Combustível (litros)</label>
                    <input id="combustivelLitros" type="number" min="0" step="0.01" placeholder="0" />
                  </div>
                </div>

                <div class="row">
                  <div class="col">
                    <label>Alimentação (R$)</label>
                    <input id="alimentacao" type="number" min="0" step="0.01" placeholder="0" />
                  </div>
                  <div class="col">
                    <label>Reserva manutenção (R$)</label>
                    <input id="manutencao" type="number" min="0" step="0.01" placeholder="0" />
                  </div>
                </div>

                <div class="row">
                  <div class="col">
                    <label>Outros gastos (R$)</label>
                    <input id="outros" type="number" min="0" step="0.01" placeholder="0" />
                  </div>
                  <div class="col">
                    <label>Pagamento extra no financiamento (R$)</label>
                    <input id="pagExtraFin" type="number" min="0" step="0.01" placeholder="0" />
                  </div>
                </div>

                <div class="row">
                  <div class="col">
                    <label><input id="pagueiParcela" type="checkbox" /> Paguei a parcela hoje</label>
                  </div>
                  <div class="col">
                    <label><input id="pagueiSeguro" type="checkbox" /> Paguei o seguro hoje</label>
                  </div>
                </div>

                <div class="btns">
                  <button class="primary" id="btnSalvarDia">Salvar dia</button>
                  <button class="secondary" id="btnCarregarDia">Carregar dia</button>
                  <button class="ghost" id="btnLimparDia">Limpar</button>
                </div>

                <div class="msg" id="msgApp">—</div>
              </div>

              <div>
                <h3 style="margin:0 0 10px">Resumo e métricas</h3>

                <div class="kpis" id="kpisTop">
                  <div class="kpi"><div class="t">Bruto hoje</div><div class="v" id="kpiBrutoHoje">—</div></div>
                  <div class="kpi"><div class="t">Líquido hoje</div><div class="v" id="kpiLiquidoHoje">—</div></div>
                  <div class="kpi"><div class="t">Bruto total (mês)</div><div class="v" id="kpiBrutoMes">—</div></div>
                  <div class="kpi"><div class="t">Líquido total (mês)</div><div class="v" id="kpiLiquidoMes">—</div></div>
                </div>

                <div class="hr"></div>

                <div class="kpis">
                  <div class="kpi"><div class="t">Gasto combustível (mês)</div><div class="v" id="kpiCombMes">—</div></div>
                  <div class="kpi"><div class="t">R$/Km (mês)</div><div class="v" id="kpiRKmMes">—</div></div>
                  <div class="kpi"><div class="t">R$/Hora (mês)</div><div class="v" id="kpiRHoraMes">—</div></div>
                  <div class="kpi"><div class="t">Meta diária (atingida?)</div><div class="v" id="kpiMeta">—</div></div>
                </div>

                <div class="hr"></div>

                <div class="kpis">
                  <div class="kpi"><div class="t">Saldo financiamento</div><div class="v" id="kpiFinSaldo">—</div></div>
                  <div class="kpi"><div class="t">Parcelas restantes</div><div class="v" id="kpiParcelasRest">—</div></div>
                  <div class="kpi"><div class="t">Parcela (R$)</div><div class="v" id="kpiParcelaVal">—</div></div>
                  <div class="kpi"><div class="t">Status relatório</div><div class="v" id="kpiStatusRel">—</div></div>
                </div>

                <div class="msg small" style="margin-top:12px">
                  O “mês” aqui considera o período do último fechamento do carro até o próximo.  
                  Se quiser exportar para Excel depois, dá para gerar CSV.
                </div>

              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="head">
          <div>
            <h2>Status rápido</h2>
            <small id="rightSub">Não logado</small>
          </div>
        </div>
        <div class="body">
          <div class="kpis">
            <div class="kpi"><div class="t">Saldo financiamento</div><div class="v" id="rFin">—</div></div>
            <div class="kpi"><div class="t">Parcelas restantes</div><div class="v" id="rParc">—</div></div>
            <div class="kpi"><div class="t">Parcela (valor)</div><div class="v" id="rParcVal">—</div></div>
            <div class="kpi"><div class="t">Status</div><div class="v" id="rStatus">—</div></div>
          </div>

          <div class="hr"></div>

          <div class="kpis">
            <div class="kpi"><div class="t">Bruto total (mês)</div><div class="v" id="rBrutoMes">—</div></div>
            <div class="kpi"><div class="t">Líquido total (mês)</div><div class="v" id="rLiquidoMes">—</div></div>
            <div class="kpi"><div class="t">Bruto hoje</div><div class="v" id="rBrutoHoje">—</div></div>
            <div class="kpi"><div class="t">Líquido hoje</div><div class="v" id="rLiquidoHoje">—</div></div>
          </div>

          <div class="msg small" style="margin-top:12px">
            Se aparecer “Offline” no topo, desative o modo Offline no DevTools (Network) e recarregue (Ctrl+Shift+R).
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Firebase (MODULAR via CDN - funciona no GitHub Pages) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      collection, query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ✅ Seu firebaseConfig (o que você mandou)
    const firebaseConfig = {
      apiKey: "AIzaSyAZCCtQvKNn94cdJdsL-ceZNR87gwoQhKg",
      authDomain: "contuber-1c9ca.firebaseapp.com",
      projectId: "contuber-1c9ca",
      storageBucket: "contuber-1c9ca.firebasestorage.app",
      messagingSenderId: "333645182595",
      appId: "1:333645182595:web:147d3ad84116b595324db6"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);
    const money = (v) => {
      const n = Number(v || 0);
      return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
    };
    const num = (v) => {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    };
    const clampInt = (v, min, max) => {
      const n = Math.floor(num(v));
      if (!Number.isFinite(n)) return min;
      return Math.min(max, Math.max(min, n));
    };
    const todayISO = () => {
      const d = new Date();
      const pad = (x) => String(x).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    };
    const isoToYMD = (iso) => iso; // already Y-M-D

    function setNetBadge(){
      const online = navigator.onLine;
      $("netDot").className = "dot " + (online ? "ok" : "bad");
      $("netTxt").textContent = online ? "Online" : "Offline";
    }
    window.addEventListener("online", setNetBadge);
    window.addEventListener("offline", setNetBadge);
    setNetBadge();

    // ---------- Views ----------
    const loginView = $("loginView");
    const setupView = $("setupView");
    const appView = $("appView");

    function showView(which){
      loginView.classList.toggle("hide", which !== "login");
      setupView.classList.toggle("hide", which !== "setup");
      appView.classList.toggle("hide", which !== "app");
      $("btnLogout").classList.toggle("hide", which !== "app");
      $("leftTitle").textContent = which === "login" ? "Login" : (which === "setup" ? "Configuração inicial" : "Painel");
      $("leftSub").textContent = which === "login"
        ? "Entre ou crie sua conta. No primeiro login, você configura os dados base."
        : (which === "setup" ? "Defina seu fechamento, seguro e financiamento." : "Lance o dia e acompanhe seu mês.");
    }

    // ---------- Firestore paths ----------
    const profileRef = (uid) => doc(db, "users", uid, "data", "profile");
    const entryRef = (uid, dateISO) => doc(db, "users", uid, "entries", dateISO);

    // ---------- Profile / Setup ----------
    async function loadProfile(uid){
      const snap = await getDoc(profileRef(uid));
      return snap.exists() ? snap.data() : null;
    }

    async function saveProfile(uid, profile){
      await setDoc(profileRef(uid), {
        ...profile,
        updatedAt: new Date().toISOString()
      }, { merge: true });
    }

    function fillSetupForm(p){
      $("carCloseDay").value = p?.carCloseDay ?? 21;
      $("metaDiaria").value = p?.metaDiaria ?? 200;
      $("finSaldo").value = p?.finSaldo ?? 0;
      $("qtdParcelas").value = p?.qtdParcelas ?? 1;
      $("valorParcela").value = p?.valorParcela ?? 0;
      $("parcelasPagas").value = p?.parcelasPagas ?? 0;
      $("seguroDay").value = p?.seguroDay ?? 15;
      $("seguroVal").value = p?.seguroVal ?? 0;
    }

    function readSetupForm(){
      const carCloseDay = clampInt($("carCloseDay").value, 1, 28);
      const metaDiaria = num($("metaDiaria").value);
      const finSaldo = num($("finSaldo").value);
      const qtdParcelas = clampInt($("qtdParcelas").value, 1, 999);
      const valorParcela = num($("valorParcela").value);
      const parcelasPagas = clampInt($("parcelasPagas").value, 0, qtdParcelas);
      const seguroDay = clampInt($("seguroDay").value, 1, 28);
      const seguroVal = num($("seguroVal").value);

      return { carCloseDay, metaDiaria, finSaldo, qtdParcelas, valorParcela, parcelasPagas, seguroDay, seguroVal };
    }

    // ---------- Entries ----------
    function calcDay(entry, profile){
      const bruto = num(entry.ganhoBruto);
      const combustivel = num(entry.combustivelValor);
      const alimentacao = num(entry.alimentacao);
      const manutencao = num(entry.manutencao);
      const outros = num(entry.outros);

      const parcelaVal = profile?.valorParcela ? num(profile.valorParcela) : 0;
      const seguroVal = profile?.seguroVal ? num(profile.seguroVal) : 0;

      const parcela = entry.pagueiParcela ? parcelaVal : 0;
      const seguro = entry.pagueiSeguro ? seguroVal : 0;

      const despesas = combustivel + alimentacao + manutencao + outros + parcela + seguro;
      const liquido = bruto - despesas;

      const km = num(entry.km);
      const horas = num(entry.horas);

      const rKm = km > 0 ? (liquido / km) : 0;
      const rHora = horas > 0 ? (liquido / horas) : 0;

      return { bruto, liquido, despesas, combustivel, rKm, rHora, parcela, seguro };
    }

    function monthWindowByCloseDay(dateISO, closeDay){
      // calcula período: do fechamento anterior (exclusive) até fechamento atual (inclusive)
      // Ex.: closeDay=21. Para data 2026-02-23: janela é 2026-01-22 .. 2026-02-21
      const d = new Date(dateISO + "T12:00:00");
      const y = d.getFullYear();
      const m = d.getMonth(); // 0-based
      const day = d.getDate();
      const cd = clampInt(closeDay, 1, 28);

      let endY = y, endM = m;
      if (day <= cd){
        // ainda não fechou no mês atual => final é cd do mês anterior
        endM = m - 1;
        if (endM < 0){ endM = 11; endY = y - 1; }
      }
      // endDate = cd do endM
      const endDate = new Date(endY, endM, cd, 12,0,0);

      // startDate = (cd+1) do mês anterior ao endDate
      let startY = endDate.getFullYear();
      let startM = endDate.getMonth() - 1;
      if (startM < 0){ startM = 11; startY -= 1; }
      const startDate = new Date(startY, startM, cd + 1, 12,0,0);

      const fmt = (dt) => {
        const pad = (x) => String(x).padStart(2,"0");
        return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`;
      };

      return { startISO: fmt(startDate), endISO: fmt(endDate) };
    }

    async function loadEntriesInRange(uid, startISO, endISO){
      // Query by document ID not possible directly with simple where for string in subcollection without __name__ advanced.
      // We'll fetch all entries (still ok for small usage) OR do range by string field.
      // We'll store dateISO in a field for range queries.
      const col = collection(db, "users", uid, "entries");
      const qy = query(col, where("dateISO", ">=", startISO), where("dateISO", "<=", endISO));
      const snap = await getDocs(qy);
      const out = [];
      snap.forEach(d => out.push(d.data()));
      // sort
      out.sort((a,b) => (a.dateISO || "").localeCompare(b.dateISO || ""));
      return out;
    }

    // ---------- UI updates ----------
    function setMsg(el, text, type=""){
      el.textContent = text;
      el.classList.remove("err","ok");
      if (type) el.classList.add(type);
    }

    function renderAlerts(profile){
      const bar = $("alertsBar");
      bar.innerHTML = "";
      if (!profile) return;

      const now = new Date();
      const dd = now.getDate();

      const carCloseDay = clampInt(profile.carCloseDay, 1, 28);
      const seguroDay = clampInt(profile.seguroDay, 1, 28);

      const addBadge = (dotClass, html) => {
        const b = document.createElement("div");
        b.className = "badge";
        b.innerHTML = `<span class="miniDot ${dotClass}"></span>${html}`;
        bar.appendChild(b);
      };

      addBadge(dd === carCloseDay ? "warn" : "ok", `<strong>Fechamento carro:</strong> dia ${carCloseDay}`);
      addBadge(dd === seguroDay ? "warn" : "ok", `<strong>Seguro:</strong> dia ${seguroDay} (${money(profile.seguroVal)})`);

      const parcelasRest = Math.max(0, num(profile.qtdParcelas) - num(profile.parcelasPagas));
      addBadge("bad", `<strong>Saldo financiamento:</strong> ${money(profile.finSaldo)}`);
      addBadge("ok", `<strong>Parcelas restantes:</strong> ${parcelasRest}`);
      addBadge("ok", `<strong>Meta diária:</strong> ${money(profile.metaDiaria)}`);

      if (dd === carCloseDay){
        addBadge("warn", `<strong>Hoje</strong> é dia de fechamento/pagamento do carro!`);
      }
      if (dd === seguroDay){
        addBadge("warn", `<strong>Hoje</strong> é dia de pagamento do seguro!`);
      }
    }

    function renderRight(profile, sums){
      $("rightSub").textContent = auth.currentUser ? "Logado" : "Não logado";

      $("rFin").textContent = profile ? money(profile.finSaldo) : "—";
      $("rParcVal").textContent = profile ? money(profile.valorParcela) : "—";
      const rest = profile ? Math.max(0, num(profile.qtdParcelas) - num(profile.parcelasPagas)) : 0;
      $("rParc").textContent = profile ? String(rest) : "—";
      $("rStatus").textContent = sums?.statusRel ?? "—";

      $("rBrutoHoje").textContent = sums ? money(sums.brutoHoje) : "—";
      $("rLiquidoHoje").textContent = sums ? money(sums.liquidoHoje) : "—";
      $("rBrutoMes").textContent = sums ? money(sums.brutoMes) : "—";
      $("rLiquidoMes").textContent = sums ? money(sums.liquidoMes) : "—";
    }

    function renderKpis(profile, sums){
      $("kpiBrutoHoje").textContent = money(sums.brutoHoje);
      $("kpiLiquidoHoje").textContent = money(sums.liquidoHoje);
      $("kpiBrutoMes").textContent = money(sums.brutoMes);
      $("kpiLiquidoMes").textContent = money(sums.liquidoMes);

      $("kpiCombMes").textContent = money(sums.combMes);
      $("kpiRKmMes").textContent = sums.kmMes > 0 ? money(sums.liquidoMes / sums.kmMes).replace("R$","R$/Km") : "—";
      $("kpiRHoraMes").textContent = sums.horasMes > 0 ? money(sums.liquidoMes / sums.horasMes).replace("R$","R$/h") : "—";

      const meta = num(profile?.metaDiaria);
      const ok = sums.brutoHoje >= meta && meta > 0;
      $("kpiMeta").textContent = meta > 0 ? (ok ? "✅ Meta batida" : "❌ Abaixo da meta") : "—";

      $("kpiFinSaldo").textContent = money(profile?.finSaldo);
      $("kpiParcelaVal").textContent = money(profile?.valorParcela);
      $("kpiParcelasRest").textContent = profile ? String(Math.max(0, num(profile.qtdParcelas)-num(profile.parcelasPagas))) : "—";
      $("kpiStatusRel").textContent = sums.statusRel;

      renderRight(profile, sums);
    }

    async function refreshDashboard(uid, profile){
      // date for "today" KPIs uses selected date
      const selectedDate = $("entryDate").value || todayISO();
      const closeDay = clampInt(profile.carCloseDay, 1, 28);
      const w = monthWindowByCloseDay(selectedDate, closeDay);

      const entries = await loadEntriesInRange(uid, w.startISO, w.endISO);

      let brutoMes=0, liquidoMes=0, combMes=0, kmMes=0, horasMes=0;

      for (const e of entries){
        const c = calcDay(e, profile);
        brutoMes += c.bruto;
        liquidoMes += c.liquido;
        combMes += c.combustivel;
        kmMes += num(e.km);
        horasMes += num(e.horas);
      }

      // today entry
      const todaySnap = await getDoc(entryRef(uid, selectedDate));
      let brutoHoje=0, liquidoHoje=0;
      if (todaySnap.exists()){
        const e = todaySnap.data();
        const c = calcDay(e, profile);
        brutoHoje = c.bruto;
        liquidoHoje = c.liquido;
      }

      // status relatório
      const now = new Date();
      const dd = now.getDate();
      const statusRel = dd === closeDay ? "Fechamento hoje" : (dd > closeDay ? "Mês em andamento" : "Mês em andamento");

      renderAlerts(profile);
      renderKpis(profile, { brutoHoje, liquidoHoje, brutoMes, liquidoMes, combMes, kmMes, horasMes, statusRel });
    }

    // ---------- Auth actions ----------
    async function doLogin(){
      try{
        setMsg($("msgLogin"), "Entrando...", "");
        const email = $("email").value.trim();
        const senha = $("senha").value;
        await signInWithEmailAndPassword(auth, email, senha);
      }catch(e){
        setMsg($("msgLogin"), `Erro: ${e?.code || e?.message || e}`, "err");
      }
    }

    async function doSignup(){
      try{
        setMsg($("msgLogin"), "Criando conta...", "");
        const email = $("email").value.trim();
        const senha = $("senha").value;
        await createUserWithEmailAndPassword(auth, email, senha);
      }catch(e){
        setMsg($("msgLogin"), `Erro: ${e?.code || e?.message || e}`, "err");
      }
    }

    async function doLogout(){
      await signOut(auth);
    }

    // ---------- Entry form ----------
    function clearEntryForm(){
      $("ganhoBruto").value = "";
      $("km").value = "";
      $("horas").value = "";
      $("combustivelValor").value = "";
      $("combustivelLitros").value = "";
      $("alimentacao").value = "";
      $("manutencao").value = "";
      $("outros").value = "";
      $("pagExtraFin").value = "";
      $("pagueiParcela").checked = false;
      $("pagueiSeguro").checked = false;
    }

    async function loadDay(uid){
      const dateISO = $("entryDate").value || todayISO();
      const snap = await getDoc(entryRef(uid, dateISO));
      if (!snap.exists()){
        clearEntryForm();
        setMsg($("msgApp"), `Sem dados para ${dateISO}.`, "");
        return;
      }
      const e = snap.data();
      $("ganhoBruto").value = e.ganhoBruto ?? "";
      $("km").value = e.km ?? "";
      $("horas").value = e.horas ?? "";
      $("combustivelValor").value = e.combustivelValor ?? "";
      $("combustivelLitros").value = e.combustivelLitros ?? "";
      $("alimentacao").value = e.alimentacao ?? "";
      $("manutencao").value = e.manutencao ?? "";
      $("outros").value = e.outros ?? "";
      $("pagExtraFin").value = e.pagExtraFin ?? "";
      $("pagueiParcela").checked = !!e.pagueiParcela;
      $("pagueiSeguro").checked = !!e.pagueiSeguro;

      setMsg($("msgApp"), `Dia ${dateISO} carregado.`, "ok");
    }

    async function saveDay(uid, profile){
      const dateISO = $("entryDate").value || todayISO();

      const entry = {
        dateISO,
        ganhoBruto: num($("ganhoBruto").value),
        km: num($("km").value),
        horas: num($("horas").value),
        combustivelValor: num($("combustivelValor").value),
        combustivelLitros: num($("combustivelLitros").value),
        alimentacao: num($("alimentacao").value),
        manutencao: num($("manutencao").value),
        outros: num($("outros").value),
        pagExtraFin: num($("pagExtraFin").value),
        pagueiParcela: $("pagueiParcela").checked,
        pagueiSeguro: $("pagueiSeguro").checked,
        updatedAt: new Date().toISOString()
      };

      // salva entry
      await setDoc(entryRef(uid, dateISO), entry, { merge: true });

      // atualiza financiamento/parcelas no profile (se marcou)
      const parcelaVal = num(profile.valorParcela);
      const seguroVal = num(profile.seguroVal);

      let novoSaldo = num(profile.finSaldo);
      let parcelasPagas = clampInt(profile.parcelasPagas, 0, clampInt(profile.qtdParcelas,1,999));

      const abatimento = num(entry.pagExtraFin) + (entry.pagueiParcela ? parcelaVal : 0);
      if (abatimento > 0){
        novoSaldo = Math.max(0, novoSaldo - abatimento);
      }
      if (entry.pagueiParcela){
        parcelasPagas = Math.min(num(profile.qtdParcelas), parcelasPagas + 1);
      }

      // grava profile com novos valores
      await updateDoc(profileRef(uid), {
        finSaldo: novoSaldo,
        parcelasPagas: parcelasPagas,
        updatedAt: new Date().toISOString()
      });

      // atualiza state local
      profile.finSaldo = novoSaldo;
      profile.parcelasPagas = parcelasPagas;

      // feedback
      const c = calcDay(entry, profile);
      setMsg($("msgApp"),
        `Salvo ${dateISO}.\nBruto: ${money(c.bruto)} • Despesas: ${money(c.despesas)} • Líquido: ${money(c.liquido)}` +
        (entry.pagueiSeguro ? `\nSeguro incluído: ${money(seguroVal)}` : "") +
        (entry.pagueiParcela ? `\nParcela incluída: ${money(parcelaVal)}` : ""),
        "ok"
      );

      await refreshDashboard(uid, profile);
    }

    // ---------- Wire buttons ----------
    $("btnEntrar").addEventListener("click", doLogin);
    $("btnCadastrar").addEventListener("click", doSignup);
    $("btnLimparLogin").addEventListener("click", () => {
      $("email").value = "";
      $("senha").value = "";
      setMsg($("msgLogin"), "Campos limpos.", "");
    });
    $("btnLogout").addEventListener("click", doLogout);

    $("btnSalvarSetup").addEventListener("click", async () => {
      try{
        const user = auth.currentUser;
        if (!user) return;
        const p = readSetupForm();
        await saveProfile(user.uid, { ...p, setup: true });
        setMsg($("msgSetup"), "Configuração salva com sucesso!", "ok");

        // vai pro app
        showView("app");
        $("userLine").textContent = `Logado como: ${user.email}`;
        $("entryDate").value = todayISO();

        const profile = await loadProfile(user.uid);
        await refreshDashboard(user.uid, profile);
      }catch(e){
        setMsg($("msgSetup"), `Erro ao salvar: ${e?.code || e?.message || e}`, "err");
      }
    });

    $("btnCancelarSetup").addEventListener("click", () => {
      // volta pro app mesmo sem setup -> não recomendado
      showView("login");
    });

    $("btnSalvarDia").addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;

      const profile = await loadProfile(user.uid);
      if (!profile?.setup){
        showView("setup");
        fillSetupForm(profile);
        setMsg($("msgSetup"), "Faça sua configuração inicial primeiro.", "err");
        return;
      }
      await saveDay(user.uid, profile);
    });

    $("btnCarregarDia").addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;
      await loadDay(user.uid);
      const profile = await loadProfile(user.uid);
      if (profile?.setup) await refreshDashboard(user.uid, profile);
    });

    $("btnLimparDia").addEventListener("click", () => {
      clearEntryForm();
      setMsg($("msgApp"), "Campos do dia limpos.", "");
    });

    $("entryDate").addEventListener("change", async () => {
      const user = auth.currentUser;
      if (!user) return;
      const profile = await loadProfile(user.uid);
      if (profile?.setup) await refreshDashboard(user.uid, profile);
    });

    // ---------- Auth state ----------
    onAuthStateChanged(auth, async (user) => {
      if (!user){
        showView("login");
        $("rightSub").textContent = "Não logado";
        $("btnLogout").classList.add("hide");
        renderRight(null, null);
        return;
      }

      // logged in
      $("btnLogout").classList.remove("hide");
      $("userLine").textContent = `Logado como: ${user.email}`;
      $("rightSub").textContent = "Logado";

      $("entryDate").value = todayISO();

      const profile = await loadProfile(user.uid);

      if (!profile || !profile.setup){
        showView("setup");
        fillSetupForm(profile);
        setMsg($("msgSetup"), "Primeiro acesso: preencha e salve a configuração inicial.", "");
      } else {
        showView("app");
        await refreshDashboard(user.uid, profile);
      }
    });
  </script>

  <!-- ✅ Firestore Rules (cole em Firestore → Rules, se estiver bloqueado) -->
  <!--
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
  -->
</body>
</html>
