<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ContUber</title>

<style>
body{font-family:Arial;background:#0f0f12;color:#fff;margin:0;padding:20px}
.card{background:#1b1b22;padding:20px;border-radius:12px;margin-bottom:20px}
input{width:100%;padding:8px;margin:5px 0;border-radius:8px;border:none}
button{padding:8px 12px;border:none;border-radius:8px;background:#ff7a00;color:#fff;cursor:pointer;margin-top:10px}
.hidden{display:none}
</style>
</head>
<body>

<h1>ContUber</h1>

<div id="auth" class="card">
<h3>Login</h3>
<input id="email" placeholder="Email">
<input id="senha" type="password" placeholder="Senha">
<button onclick="login()">Entrar</button>
<button onclick="registrar()">Cadastrar</button>
</div>

<div id="setup" class="card hidden">
<h3>Configuração Inicial</h3>
<input id="financiado" type="number" placeholder="Valor financiado">
<input id="seguroValor" type="number" placeholder="Valor do seguro">
<input id="parcelaValor" type="number" placeholder="Valor da parcela do carro">
<input id="diaCarro" type="number" placeholder="Dia do carro (1-28)">
<input id="diaSeguro" type="number" placeholder="Dia do seguro (1-28)">
<button onclick="salvarSetup()">Salvar</button>
</div>

<div id="app" class="card hidden">
<h3>Painel</h3>

<input id="bruto" type="number" placeholder="Valor bruto">
<input id="combustivel" type="number" placeholder="Combustível">
<input id="manutencao" type="number" placeholder="Manutenção">
<input id="outros" type="number" placeholder="Outros gastos">

<label><input type="checkbox" id="parcelaPaga"> Parcela paga</label><br>
<label><input type="checkbox" id="seguroPago"> Seguro pago</label>

<h3>Total Gastos: R$ <span id="totalGastos">0</span></h3>
<h2>Líquido: R$ <span id="liquido">0</span></h2>

<button onclick="salvarCiclo()">Salvar Ciclo</button>
<button onclick="logout()">Sair</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAZCCtQvKNn94cdJdSL-ceZNR87gwoQhKg",
  authDomain: "contuber-1c9ca.firebaseapp.com",
  projectId: "contuber-1c9ca",
  storageBucket: "contuber-1c9ca.firebasestorage.app",
  messagingSenderId: "333645182595",
  appId: "1:333645182595:web:147d3ad84116b595324db6"
};

const appFirebase = initializeApp(firebaseConfig);
const auth = getAuth(appFirebase);
const db = getFirestore(appFirebase);

const authDiv=document.getElementById("auth");
const setupDiv=document.getElementById("setup");
const appDiv=document.getElementById("app");

function mostrar(div){
authDiv.classList.add("hidden");
setupDiv.classList.add("hidden");
appDiv.classList.add("hidden");
div.classList.remove("hidden");
}

window.login=async()=>{
await signInWithEmailAndPassword(auth,email.value,senha.value);
}

window.registrar=async()=>{
await createUserWithEmailAndPassword(auth,email.value,senha.value);
}

window.logout=()=>signOut(auth);

window.salvarSetup=async()=>{
const user=auth.currentUser;
await setDoc(doc(db,"users",user.uid,"dados","perfil"),{
financiado:+financiado.value,
seguroValor:+seguroValor.value,
parcelaValor:+parcelaValor.value,
diaCarro:+diaCarro.value,
diaSeguro:+diaSeguro.value,
setup:true
});
mostrar(appDiv);
}

window.salvarCiclo=async()=>{
const user=auth.currentUser;
const brutoVal=+bruto.value||0;
const gastos=+combustivel.value+ +manutencao.value+ +outros.value;
const parcela=parcelaPaga.checked?+parcelaValor.value:0;
const seguro=seguroPago.checked?+seguroValor.value:0;
const total=gastos+parcela+seguro;
const liquidoVal=brutoVal-total;

await setDoc(doc(db,"users",user.uid,"ciclo","atual"),{
bruto:brutoVal,
combustivel:+combustivel.value,
manutencao:+manutencao.value,
outros:+outros.value,
parcelaPaga:parcelaPaga.checked,
seguroPago:seguroPago.checked,
total,
liquido:liquidoVal
});

alert("Ciclo salvo!");
}

function calcular(){
const brutoVal=+bruto.value||0;
const gastos=+combustivel.value+ +manutencao.value+ +outros.value;
const parcela=parcelaPaga.checked?+parcelaValor.value:0;
const seguro=seguroPago.checked?+seguroValor.value:0;
const total=gastos+parcela+seguro;
const liquidoVal=brutoVal-total;
totalGastos.textContent=total.toFixed(2);
liquido.textContent=liquidoVal.toFixed(2);
}

["input","change"].forEach(ev=>{
document.addEventListener(ev,calcular);
});

onAuthStateChanged(auth,async(user)=>{
if(!user){mostrar(authDiv);return;}
const snap=await getDoc(doc(db,"users",user.uid,"dados","perfil"));
if(!snap.exists()||!snap.data().setup){mostrar(setupDiv);}
else{
const dados=snap.data();
parcelaValor.value=dados.parcelaValor;
seguroValor.value=dados.seguroValor;
mostrar(appDiv);
}
});
</script>

</body>
</html>
